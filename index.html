<!-- MEF 2026 Index.html - PART 1 OF 4 -->
<!-- working16.38 14_01_26 - WITH SECTION MARKERS -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manningtree Earth Festival 2026</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- ============================================ -->
<!-- SECTION START: CSS STYLES -->
<!-- ============================================ -->
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: "Segoe UI", SegoeUI, Tahoma, Arial, sans-serif; min-height: 100vh; background: #fff; overflow-x: hidden; }
nav { background: linear-gradient(135deg, #2B7BBD 0%, #5BA3D0 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.nav-title { display: flex; align-items: center; gap: 15px; flex-shrink: 1; min-width: 0; }
.nav-title img { height: 150px; border-radius: 10px; border: 2px solid white; filter: drop-shadow(2px 2px 2px #000); flex-shrink: 0; }
.nav-title div { display: flex; flex-direction: column; min-width: 0; }
.nav-title h1 { font-size: 2em; font-weight: bold; margin: 0; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.nav-title p { margin: 0; color: #8DC63F; font-weight: bold; }
.nav-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
.nav-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1em; font-family: inherit; transition: all 0.3s ease; }
.nav-btn.active, .nav-btn:hover { background: #8DC63F; }
.content { max-width: 1200px; margin: 0 auto; padding: 40px 20px 20px 20px; }
.page { display: none; }
.page.active { display: block; }
.hero { background: linear-gradient(135deg, #8DC63F 0%, #A8D96A 100%); color: white; padding: 50px 40px; border-radius: 15px; margin-bottom: 40px; text-align: center; }
.hero h2 { font-size: 2.5em; margin-bottom: 20px; line-height: 1.2; }
.hero p { font-size: 1.3em; max-width: 800px; margin: 0 auto; line-height: 1.2; }
section { margin-bottom: 50px; }
h2 { color: #2B7BBD; font-size: 2em; margin-bottom: 20px; }
.pace-website-btn {
  background: #8DC63F !important;
  color: white !important;
  border: 2px solid #8DC63F !important;
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1em;
  font-family: inherit;
  transition: all 0.3s ease;
}
.pace-website-btn:hover {
  background: #7AB62F !important;
}
p { font-size: 1.1em; line-height: 1.4; margin-bottom: 15px; }
.goal-item { background: white; padding: 20px; margin: 15px 0; border-left: 5px solid #8DC63F; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 1.1em; line-height: 1.5; }
.contact-box { background: #2B7BBD; color: white; padding: 40px; border-radius: 15px; margin-top: 30px; text-align: center; word-wrap: break-word; }
.contact-box a { color: #8DC63F; font-weight: bold; word-wrap: break-word; overflow-wrap: break-word; }
.filters { background: #f5f5f5; padding: 25px; border-radius: 10px; margin-bottom: 30px; box-sizing: border-box; width: 100%; }
.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; width: 100%; }
.filter-group { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
.filter-group label { font-weight: bold; color: #2B7BBD; font-size: 0.9em; }
.filter-group input, .filter-group select { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em; width: 100%; box-sizing: border-box; }
/* Event Grid Layout */
#eventsList { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
  gap: 20px; 
  margin-top: 30px;
}
#eventsList > p { 
  grid-column: 1 / -1; /* Make the info text span all columns */
}

/* Event Cards - Brightlingsea Style */
.event-card { 
  background: white; 
  border: 3px solid #333; 
  border-radius: 8px; 
  overflow: hidden; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  display: flex;
  flex-direction: column;
}
.event-card:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
}
.event-card-header { 
  padding: 15px; 
  font-size: 1.1em; 
  font-weight: bold; 
  color: white; 
  min-height: 50px;
  display: flex;
  align-items: center;
}
.event-card-header.color-orange { background: #ff8c42; }
.event-card-header.color-green { background: #8DC63F; }
.event-card-body { 
  padding: 20px; 
  flex: 1;
  display: flex;
  flex-direction: column;
}
.event-card-info { 
  margin-bottom: 10px; 
  color: #555; 
  font-size: 0.95em; 
  line-height: 1.5; 
}
.event-card-description { 
  margin-top: 12px; 
  margin-bottom: 15px; 
  color: #444; 
  font-size: 0.95em; 
  line-height: 1.5;
  flex: 1;
}
.event-card-cta {
  color: #2B7BBD;
  font-weight: bold;
  font-size: 1em;
  text-align: right;
  margin-top: 10px;
}

/* Old event card styles kept for other pages */
.event-card img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 20px; }
.event-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
.event-title { color: #2B7BBD; font-size: 1.8em; margin: 0; }
.event-meta { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; color: #666; }
.tags { display: flex; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
.tag { background: #8DC63F; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
.event-link { display: inline-block; background: #2B7BBD; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin: 5px 5px 5px 0; font-weight: bold; transition: all 0.3s ease; }
.event-link:hover { background: #1a5a8d; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.event-link.register { background: #8DC63F; }
.event-link.register:hover { background: #7AB62F; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; max-width: 900px; margin: 0 auto; width: 100%; }
.calendar-header { font-weight: bold; text-align: center; padding: 10px; color: #2B7BBD; font-size: 1.1em; }
.calendar-day { min-height: 100px; padding: 10px; background: white; border: 2px solid #e0e0e0; border-radius: 10px; position: relative; transition: all 0.3s ease; overflow: hidden; }
.calendar-day.has-events { background: #8DC63F; cursor: pointer; }
.calendar-day.has-events:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.calendar-day-number { font-weight: bold; font-size: 1.2em; }
.calendar-day.has-events .calendar-day-number { color: white; }
.event-count { position: absolute; bottom: 5px; right: 5px; background: white; color: #2B7BBD; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; }
.admin-login { max-width: 400px; margin: 20px auto; text-align: center; }
.admin-input { width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #2B7BBD; border-radius: 10px; margin-bottom: 20px; font-family: inherit; }
.btn { background: #8DC63F; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; font-family: inherit; white-space: nowrap; }
.btn:hover { background: #7AB62F; }
.btn-secondary { background: #666; }
.btn-secondary:hover { background: #555; }
.btn-export { background: #2B7BBD; margin-left: 10px; margin-top: 10px; }
.admin-panel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow: hidden; overscroll-behavior: contain; }
.modal.active { display: flex; align-items: center; justify-content: center; }
#eventModal { display: none; }
#eventModal.active { display: flex; }
.modal-content { background: white; padding: 40px; border-radius: 15px; max-width: 700px; max-height: 90vh; overflow-y: auto; width: calc(100% - 40px); box-sizing: border-box; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; font-size: 1em; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; }
.form-group textarea { min-height: 100px; resize: vertical; }
.form-group small { display: block; margin-top: 5px; color: #666; font-size: 0.9em; }
.form-actions { display: flex; flex-direction: column; gap: 15px; justify-content: stretch; margin-top: 30px; }
.form-actions .btn { width: 100%; }
.icon-btn { background: #2B7BBD; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; white-space: nowrap; }
.icon-btn.delete { background: #dc3545; }
.admin-info { background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #8DC63F; margin: 20px 0 15px 0; }
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.admin-event-item { background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #8DC63F; display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-wrap: wrap; }
.admin-event-info { flex: 1; min-width: 0; word-wrap: break-word; }
.admin-event-title { color: #2B7BBD; font-size: 1.3em; margin: 0 0 8px 0; font-weight: bold; word-wrap: break-word; }
.admin-event-meta { color: #666; font-size: 0.95em; margin: 5px 0; word-wrap: break-word; }
.admin-event-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.admin-event-actions button { padding: 8px 16px; font-size: 0.9em; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
.btn-edit { background: #2B7BBD; color: white; }
.btn-edit:hover { background: #1a5a8d; }
.btn-data { background: #8DC63F; color: white; }
.btn-data:hover { background: #7ab52f; }
.btn-delete { background: #dc3545; color: white; }
.btn-delete:hover { background: #c82333; }
.pride-banner { background: linear-gradient(90deg, #FF0018 0%, #FFA52C 16.67%, #FFFF41 33.33%, #008018 50%, #0000F9 66.67%, #86007D 83.33%, #FF0018 100%); color: white; padding: 3px; border-radius: 8px; font-size: 0.75em; font-weight: bold; text-align: center; margin-top: 5px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.pride-banner-text { background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 5px; }
.pride-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px; overflow-y: auto; }
.pride-modal.active { display: flex; align-items: center; justify-content: center; }
.pride-modal-content { background: white; padding: 40px; border-radius: 15px; max-width: 600px; text-align: center; position: relative; }
.pride-modal-header { background: linear-gradient(90deg, #FF0018 0%, #FFA52C 16.67%, #FFFF41 33.33%, #008018 50%, #0000F9 66.67%, #86007D 83.33%); padding: 5px; border-radius: 10px; margin-bottom: 20px; }
.pride-modal-title { background: white; padding: 20px; border-radius: 8px; color: #2B7BBD; font-size: 2em; font-weight: bold; margin: 0; }
.event-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; overflow-y: auto; padding: 20px 0; }
.event-modal.active { display: block; }
.event-modal-content { background: white; border-radius: 20px; max-width: 800px; width: calc(100% - 40px); margin: 20px auto; position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
.event-modal-header { background: linear-gradient(135deg, #2B7BBD 0%, #5BA3D0 100%); color: white; padding: 50px 40px; text-align: center; position: relative; }
.event-modal-close { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; transition: all 0.3s ease; }
.event-modal-close:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
.event-modal-title { font-size: 2.5em; margin: 0 0 15px 0; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
.event-modal-subtitle { font-size: 1.2em; opacity: 1; margin: 0; color: #8DC63F; font-weight: bold; }
.event-modal-body { padding: 40px; }
.event-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.event-detail-item { background: #f5f5f5; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #8DC63F; }
.event-detail-label { font-size: 0.85em; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
.event-detail-value { font-size: 1.3em; color: #2B7BBD; font-weight: bold; }
.event-description { font-size: 1.1em; line-height: 1.5; color: #333; margin: 30px 0; padding: 25px; background: #f9f9f9; border-radius: 12px; border-left: 5px solid #8DC63F; }
.event-modal-actions { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee; }
.event-modal-btn { padding: 15px 35px; font-size: 1.1em; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
.event-modal-btn-primary { background: #8DC63F; color: white; }
.event-modal-btn-primary:hover { background: #7AB62F; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(141,198,63,0.4); }
.event-modal-btn-secondary { background: #2B7BBD; color: white; }
.event-modal-btn-secondary:hover { background: #1a5a8d; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(43,123,189,0.4); }
.organisation-section { background: linear-gradient(135deg, #f9f9f9 0%, #f0f0f0 100%); padding: 30px; border-radius: 12px; margin: 30px 0; border: 2px solid #8DC63F; }
.organisation-section h3 { color: #2B7BBD; margin: 0 0 15px 0; font-size: 1.5em; }
.organisation-section p { line-height: 1.5; color: #333; margin-bottom: 15px; }

/* RESPONSIVE STYLES */
@media (max-width: 768px) { 
  .nav-container { flex-direction: column; text-align: center; } 
  .nav-title { width: 100%; justify-content: center; flex-direction: column; }
  .nav-title h1 { font-size: 1.4em; white-space: normal; }
  .nav-buttons { width: 100%; justify-content: center; }
  .btn { padding: 10px 20px; font-size: 0.9em; margin: 3px; }
  .btn-export { margin-left: 0; margin-top: 5px; }
  .calendar-grid { gap: 5px; grid-template-columns: repeat(7, 1fr); } 
  .calendar-day { min-height: 70px; padding: 5px; font-size: 0.8em; } 
  .calendar-day > div:first-child { flex-direction: column !important; gap: 2px !important; }
  .calendar-day-number { font-size: 0.9em; }
  .filters { padding: 15px; }
  .filters-grid { grid-template-columns: 1fr; gap: 10px; }
  .two-col { grid-template-columns: 1fr; }
  .modal { align-items: flex-start; padding-top: 20px; }
  .modal-content { padding: 20px; width: calc(100% - 20px); max-height: 85vh; margin: 0 auto; }
  .form-actions { justify-content: stretch; flex-direction: column; }
  .form-actions .btn { flex: 1; min-width: 0; width: 100%; }
  .admin-panel { flex-direction: column; align-items: stretch; }
  .admin-panel > div { display: flex; flex-wrap: wrap; gap: 10px; }
  .admin-event-item { flex-direction: column; }
  .admin-event-actions { width: 100%; flex-direction: column; }
  .admin-event-actions button { width: 100%; }
  .event-title { font-size: 1.4em; }
  .hero { padding: 40px 20px; }
  .hero h2 { font-size: 1.6em; line-height: 1.3; }
  .hero p { font-size: 1em; line-height: 1.1; }
  section { margin-bottom: 30px; }
  h2 { font-size: 1.6em; }
  p { font-size: 1em; line-height: 1.3; }
  .goal-item { padding: 20px; font-size: 1em; line-height: 1.4; }
  .contact-box { padding: 30px 20px; word-wrap: break-word; }
  .contact-box a { font-size: 0.9em; word-break: break-all; }
  .week-header { font-size: 1em; padding: 0 10px; }
  .admin-login { margin: 20px auto; }
  .admin-event-item { padding: 15px; }
  .admin-event-title { font-size: 1.1em; }
  .admin-event-meta { font-size: 0.85em; }
  #calendarViewContainer > div { padding: 0 5px !important; }
  #calendarViewContainer > div > div:last-child { 
    display: grid !important; 
    grid-template-columns: 1fr !important; 
    gap: 10px !important; 
  }
  #calendarViewContainer > div > div:last-child > div {
    min-height: auto !important;
    padding: 10px !important;
  }
  .event-modal-content { width: calc(100% - 20px); margin: 20px auto; }
  .event-modal-header { padding: 30px 20px; }
  .event-modal-title { font-size: 1.6em; line-height: 1.2; }
  .event-modal-subtitle { font-size: 1em; }
  .event-modal-body { padding: 20px; }
  .event-detail-grid { grid-template-columns: 1fr; gap: 10px; }
  .event-detail-item { padding: 12px; }
  .event-detail-label { font-size: 0.75em; }
  .event-detail-value { font-size: 1em; word-wrap: break-word; }
  .event-description { font-size: 0.95em; line-height: 1.4; padding: 15px; }
  .organisation-section { padding: 15px; margin: 20px 0; }
  .organisation-section h3 { font-size: 1.2em; word-wrap: break-word; }
  .organisation-section p { font-size: 0.95em; line-height: 1.4; word-wrap: break-word; }
  .event-modal-actions { flex-direction: column; }
  .event-modal-btn { width: 100%; padding: 12px 20px; font-size: 1em; }
}

/* Toast animations */
@keyframes slideUp {
  from {
    bottom: 0;
    opacity: 0;
  }
  to {
    bottom: 30px;
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}
</style>
<!-- SECTION END: CSS STYLES -->

</head>
<body>

<!-- ============================================ -->
<!-- SECTION START: NAVIGATION -->
<!-- ============================================ -->
<nav>
<div class="nav-container">
<div class="nav-title">
<img src="https://mcusercontent.com/6fcff65c5695e0ab56345c711/_compresseds/dc065ad1-455d-7752-4079-c7f1a0721c62.jpg" alt="MEF Logo">
<div>
<p style="font-size: 1.8em; font-weight: bold; line-height: 1.2;">23 MAY - 30 JUNE 2026</p>
</div>
</div>
<div class="nav-buttons">
<button class="nav-btn active" onclick="showPage('home', this)">Home</button>
<button class="nav-btn" onclick="showPage('events', this)">Events</button>
<button class="nav-btn" onclick="showPage('calendar', this)">Calendar</button>
<button class="nav-btn" onclick="showPage('about', this)">About</button>
<button class="nav-btn" onclick="openFestivalAdmin()">Festival Admin</button>
<button class="pace-website-btn" onclick="window.location.href='https://www.pacemanningtree.org.uk'">â† PACE Website</button>
</div>
</div>
</nav>

<!-- SECTION END: NAVIGATION -->

<!-- END OF PART 1 - Continue to Part 2 -->

<!-- MEF 2026 Index.html - PART 2 OF 4 -->
<!-- HTML PAGES AND MODALS -->

<!-- ============================================ -->
<!-- SECTION START: PAGE CONTENT CONTAINER -->
<!-- ============================================ -->
<div class="content">

<!-- HOME PAGE -->
<div id="home" class="page active">
<div class="hero">
<h2 style="font-style: italic; font-size: 2.2em;">Discovering What We Can Do</h2>
<p style="font-size: 1.4em; margin-bottom: 30px;">A 5-week series of events celebrating community action, environmental awareness, and positive change through films, talks, workshops, performances, music, exhibitions, debates, and more.</p>

<div style="background: rgba(255,255,255,0.95); padding: 25px; border-radius: 12px; margin-top: 30px; color: #333;">
<h3 style="font-size: 1.6em; margin-bottom: 15px; color: #2B7BBD;">How It Works</h3>
<p style="font-size: 1.1em; line-height: 1.6;">
âœ¨ Browse events by <strong>Calendar</strong> or <strong>Events</strong> tab above<br>
ğŸŸï¸ Reserve your place through <strong>Eventbrite</strong> (links on each event)<br>
ğŸ’š Most events are <strong>FREE</strong> - donations welcome to support our community<br>
ğŸŒ Discover films, talks, workshops, performances, and more
</p>
</div>
</div>

<section>
<h2>Welcome to MEF 2026</h2>
<p>The Manningtree Earth Festival is coordinated by volunteers from PACE Manningtree and delivered by passionate members of our community. From May 23rd to June 30th, 2026, we're bringing together knowledge, skills, and connections to help us all understand climate change, biodiversity loss, and the practical actions we can take.</p>
</section>

<section>
<h2>Festival Goals</h2>
<div class="goal-item">Understanding the changing climate, the loss of biodiversity and the impacts on our environment</div>
<div class="goal-item">Actions individuals, organisations and businesses can take to benefit our community</div>
<div class="goal-item">Building resilience for our community as the environment changes</div>
</section>

<div class="contact-box">
<h3 style="color: white; font-size: 1.8em; margin-bottom: 15px;">Get in Touch</h3>
<p>Contact us at: <a href="/cdn-cgi/l/email-protection#5b163a353532353c2f293e3e1e3a292f331d3e282f322d3a371b3c363a323775383436"><span class="__cf_email__" data-cfemail="2d604c434344434a595f4848684c5f59456b485e59445b4c416d4a404c4441034e4240">[email&#160;protected]</span></a></p>
<p style="margin-top: 20px;">Learn more about PACE: <a href="https://www.pacemanningtree.org.uk/" target="_blank">www.pacemanningtree.org.uk</a></p>
</div>

</div>
<!-- END home page -->

<!-- ============================================ -->
<!-- SECTION START: EVENTS PAGE -->
<!-- ============================================ -->
<div id="events" class="page">
<h2 style="text-align: center; font-size: 2.5em; margin-bottom: 30px;">Festival Events</h2>
<div style="text-align: center; margin-bottom: 20px;">
  <button class="btn" onclick="toggleFilters()" id="filterToggle">Show Filters</button>
</div>
<div class="filters" id="filtersPanel" style="display: none;">
<div class="filters-grid">
<div class="filter-group"><label>Search</label><input type="text" id="searchInput" placeholder="Search events..." onkeyup="applyFilters()"></div>
<div class="filter-group"><label>Event Type</label><select id="typeFilter" onchange="applyFilters()"><option value="">All Types</option></select></div>
<div class="filter-group"><label>Location</label><select id="locationFilter" onchange="applyFilters()"><option value="">All Locations</option></select></div>
<div class="filter-group"><label>Date</label><input type="date" id="dateFilter" min="2026-05-23" max="2026-06-30" onchange="applyFilters()"></div>
</div>
<button class="btn" onclick="clearFilters()" style="padding: 10px 20px; font-size: 0.9em;">Clear Filters</button>
</div>
<div id="eventsList"></div>
</div>
<!-- SECTION END: EVENTS PAGE -->

<!-- ============================================ -->
<!-- SECTION START: CALENDAR PAGE -->
<!-- ============================================ -->
<div id="calendar" class="page">
<h2 style="text-align: center; font-size: 2.5em; margin-bottom: 20px;">Festival Calendar</h2>
<div style="text-align: center; margin-bottom: 30px;">
  <button class="btn" onclick="showCalendarView('day')" style="padding: 10px 20px; margin: 5px;">Day</button>
  <button class="btn" onclick="showCalendarView('week')" style="padding: 10px 20px; margin: 5px;">Week</button>
  <button class="btn" onclick="showCalendarView('month')" style="padding: 10px 20px; margin: 5px;">Full Festival</button>
</div>
<div id="calendarViewContainer"></div>
</div>
<!-- SECTION END: CALENDAR PAGE -->


<!-- ============================================ -->
<!-- SECTION START: ABOUT PAGE -->
<!-- ============================================ -->
<div id="about" class="page">
<h2 style="text-align: center; font-size: 2.5em; margin-bottom: 30px;">About the Festival</h2>

<section>
<h2>What is MEF 2026?</h2>
<p>The Manningtree Earth Festival (MEF) is a community-driven celebration of environmental action and awareness. Over five weeks, from May 23rd to June 30th, 2026, local volunteers and community members come together to deliver an inspiring programme of events.</p>
</section>

<section>
<h2>How to Use This Site</h2>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #8DC63F;">
<h3 style="color: #2B7BBD; margin-bottom: 15px;">ğŸ“… Browse by Calendar</h3>
<p style="margin-bottom: 20px;">Click the <strong>Calendar</strong> tab to see all events laid out by date. Perfect for planning your month!</p>

<h3 style="color: #2B7BBD; margin-bottom: 15px;">ğŸ“‹ Browse by Events List</h3>
<p style="margin-bottom: 20px;">Click the <strong>Events</strong> tab to see all events with full descriptions. Filter by type, topic, or search for keywords.</p>

<h3 style="color: #2B7BBD; margin-bottom: 15px;">ğŸŸï¸ Reserve Your Place</h3>
<p style="margin-bottom: 20px;">Most events require reservation through <strong>Eventbrite</strong>. Click the Eventbrite link on any event to book your spot.</p>

<h3 style="color: #2B7BBD; margin-bottom: 15px;">ğŸ’š Free Events & Donations</h3>
<p>Most events are completely FREE to attend. However, donations are welcome and help support future community initiatives. You can donate when booking through Eventbrite.</p>
</div>
</section>

<section>
<h2>Our Mission</h2>
<p>MEF 2026 aims to provide information, knowledge, and choices so that we can all become:</p>
<div style="display: grid; gap: 15px; margin-top: 20px;">
<div class="goal-item">âœ“ More aware of climate change and biodiversity loss</div>
<div class="goal-item">âœ“ Better equipped with practical skills and knowledge</div>
<div class="goal-item">âœ“ More resilient to environmental challenges</div>
<div class="goal-item">âœ“ Connected to our community and shared future</div>
</div>
</section>

<section>
<h2>About PACE Manningtree</h2>
<p>PACE (Positive Action for Climate and Environment) Manningtree is a volunteer-led organisation dedicated to environmental action in our local community. We coordinate the MEF festival, but the events are delivered by passionate community members like you!</p>
<p style="margin-top: 15px;">Learn more at: <a href="https://www.pacemanningtree.org.uk/" target="_blank" style="color: #2B7BBD; font-weight: bold;">www.pacemanningtree.org.uk</a></p>
</section>

<div class="contact-box">
<h3 style="color: white; font-size: 1.8em; margin-bottom: 15px;">Get in Touch</h3>
<p>Questions about the festival? Contact us at: <a href="/cdn-cgi/l/email-protection#5b163a353532353c2f293e3e1e3a292f331d3e282f322d3a371b3c363a323775383436"><span class="__cf_email__" data-cfemail="2d604c434344434a595f4848684c5f59456b485e59445b4c416d4a404c4441034e4240">[email&#160;protected]</span></a></p>
</div>
</div>
<!-- SECTION END: ABOUT PAGE -->


<!-- ============================================ -->
<!-- SECTION START: PACE PLANNING PAGE -->
<!-- ============================================ -->
<div id="paceplanning" class="page">
<div id="pacePlanningLogin" class="admin-login">
<h2>PACE Planning Access</h2>
<p style="margin-bottom: 20px;">Enter password to view events in planning</p>
<input type="password" id="pacePlanningPassword" class="admin-input" placeholder="Enter PACE password" onkeypress="if(event.key==='Enter') pacePlanningLogin()" autofocus>
<button class="btn" onclick="pacePlanningLogin()">Access Planning</button>
</div>
<div id="pacePlanningPanel" style="display: none;">
<h2 style="color: #2B7BBD; margin-bottom: 20px;">ğŸ“‹ PACE Planning</h2>

<!-- VIEW TOGGLE BUTTONS -->
<div style="text-align: center; margin-bottom: 30px;">
  <button id="btnPlanningEvents" class="btn" onclick="showPlanningView('events')" style="margin: 0 10px; background: #2B7BBD;">ğŸ“… Events</button>
  <button id="btnPlanningVenues" class="btn btn-secondary" onclick="showPlanningView('venues')" style="margin: 0 10px;">ğŸ›ï¸ Venues</button>
</div>

<!-- EVENTS VIEW -->
<div id="planningEventsView">
<p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1em;">
These events are being developed. Use the filters to see what's planned for each week and day. Click any event to view full details.
</p>

<!-- FILTERS -->
<!-- SEARCH BOX -->
<div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
<label style="display: block; font-weight: bold; color: #2B7BBD; margin-bottom: 10px;">ğŸ” Search Events</label>
<input type="text" id="searchPlanning" placeholder="Search by Event ID or Title..." style="width: 100%; padding: 12px; font-size: 1em; border: 2px solid #ddd; border-radius: 8px;" oninput="applyPlanningFilters()">
<small style="display: block; margin-top: 8px; color: #666;">Tip: Search by your initials to find your events (e.g., "HH" or "JS")</small>
</div>

<div class="filters">
<h3 style="color: #2B7BBD; margin-bottom: 15px;">Filter by:</h3>
<div class="filters-grid">
<div class="filter-group">
<label>Week</label>
<select id="filterWeek" onchange="applyPlanningFilters()">
<option value="">All Weeks</option>
<option value="Festival Week 1">Festival Week 1 (23-29 May)</option>
<option value="Festival Week 2">Festival Week 2 (30 May-5 Jun)</option>
<option value="Festival Week 3">Festival Week 3 (6-12 Jun)</option>
<option value="Festival Week 4">Festival Week 4 (13-19 Jun)</option>
<option value="Festival Week 5">Festival Week 5 (20-26 Jun)</option>
<option value="Festival Week 6">Festival Week 6 (27-30 Jun)</option>
</select>
</div>
<div class="filter-group">
<label>Day</label>
<select id="filterDay" onchange="applyPlanningFilters()">
<option value="">All Days</option>
<option value="Monday">Monday</option>
<option value="Tuesday">Tuesday</option>
<option value="Wednesday">Wednesday</option>
<option value="Thursday">Thursday</option>
<option value="Friday">Friday</option>
<option value="Saturday">Saturday</option>
<option value="Sunday">Sunday</option>
</select>
</div>
<div class="filter-group">
<label>Time of Day</label>
<select id="filterTime" onchange="applyPlanningFilters()">
<option value="">All Times</option>
<option value="Morning">Morning</option>
<option value="Afternoon">Afternoon</option>
<option value="Evening">Evening</option>
</select>
</div>
<div class="filter-group">
<label>PACE Lead</label>
<select id="filterPaceLead" onchange="applyPlanningFilters()">
<option value="">All PACE Leads</option>
</select>
</div>
<div class="filter-group">
<label>Calendar</label>
<select id="filterCalendar" onchange="applyPlanningFilters()">
<option value="all">All Events</option>
<option value="notcalendar">Not on Calendar</option>
<option value="oncalendar">On Calendar</option>
</select>
</div>
</div>
<div style="margin-top: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
<button class="btn btn-secondary" onclick="clearPlanningFilters()">Clear Filters</button>
<label style="font-weight: bold; color: #2B7BBD;">Sort by:</label>
<select id="sortPlanning" onchange="applyPlanningFilters()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc;">
<option value="title">Title (A-Z)</option>
<option value="paceLead">PACE Lead (A-Z)</option>
</select>
</div>
</div>

<!-- EVENT COUNTER -->
<div style="text-align: center; margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 8px; border: 2px solid #2B7BBD;">
<span style="font-size: 1.2em; font-weight: bold; color: #2B7BBD;">Showing <span id="planningEventCount">0</span> events</span>
</div>

<!-- EVENTS LIST -->
<div id="planningEventsList" style="margin-top: 30px;"></div>
</div>
<!-- END EVENTS VIEW -->

<!-- VENUES VIEW -->
<div id="planningVenuesView" style="display: none;">
<p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 1.1em;">
Manage venue profiles including capacity, facilities, and availability.
</p>

<div style="text-align: center; margin-bottom: 30px;">
  <button class="btn" onclick="openVenueForm()" style="font-size: 1.1em; padding: 15px 30px;">+ Add New Venue</button>
</div>

<!-- VENUE COUNTER -->
<div style="text-align: center; margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 8px; border: 2px solid #2B7BBD;">
<span style="font-size: 1.2em; font-weight: bold; color: #2B7BBD;"><span id="venueCount">0</span> venues</span>
</div>

<!-- VENUES LIST -->
<div id="venuesList"></div>
</div>
<!-- END VENUES VIEW -->

</div>
</div>
<!-- SECTION END: PACE PLANNING PAGE -->
<!-- ============================================ -->

<!-- ============================================ -->
<!-- SECTION START: PACE LEAD PORTAL PAGE -->
<!-- ============================================ -->
<div id="paceleadportal" class="page">
<div id="paceLeadLogin" class="admin-login">
<h2>PACE Lead Portal</h2>
<p style="margin-bottom: 20px;">Enter your access code to view and edit your events</p>
<input type="text" id="paceLeadCode" class="admin-input" placeholder="Enter your code (e.g., HH1234)" onkeypress="if(event.key==='Enter') paceLeadLogin()" autofocus>
<button class="btn" onclick="paceLeadLogin()">Access My Events</button>
<p style="margin-top: 20px; font-size: 0.9em; color: #666;">Your access code was provided when you submitted your first event via JotForm.</p>
</div>
<div id="paceLeadPanel" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
<h2 style="margin: 0; color: #2B7BBD;">My Events</h2>
<div>
<button class="btn" onclick="openEventForm()">+ Add New Event</button>
<button class="btn btn-secondary" onclick="paceLeadLogout()">Logout</button>
</div>
</div>
<div id="paceLeadInfo" class="admin-info" style="display: none;">
<p><strong>Logged in as:</strong> <span id="paceLeadCodeDisplay"></span></p>
<p style="margin-top: 10px; font-size: 0.9em;">You can view and edit all events associated with your code.</p>
</div>
<div style="background: #f5f5f5; padding: 30px; border-radius: 10px;">
<p style="font-size: 1.2em; margin-bottom: 20px; text-align: center;">Your Events: <strong id="paceLeadEventCount">0</strong></p>
<div id="paceLeadEventsList" style="display: grid; gap: 15px;"></div>
</div>
</div>
</div>
<!-- SECTION END: PACE LEAD PORTAL PAGE -->
<!-- ============================================ -->



<!-- ============================================ -->
<!-- SECTION START: ADMIN PAGE -->
<!-- ============================================ -->

<div id="admin" class="page">
<div id="adminLogin" class="admin-login">
<h2>Admin Login</h2>
<input type="password" id="adminPassword" class="admin-input" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()" autofocus>
<button class="btn" onclick="login()">Login</button>
</div>
<div id="adminPanel" style="display: none;">
<div class="admin-panel">
<h2 style="margin: 0;">Event Management</h2>
<!-- Version: 2025-01-31-PRINT-FIX-2 -->
<div>
<button class="btn" onclick="openEventForm()">+ Add New Event</button>
<button class="btn" onclick="showPage('paceplanning'); showPlanningView('venues');" style="background: #8DC63F;">ğŸ›ï¸ Manage Venues</button>
<button class="btn btn-export" onclick="exportToExcel()">ğŸ“Š Export to Excel</button>
<button class="btn btn-export" onclick="document.getElementById('importFile').click()">ğŸ“¥ Import from Excel</button>
<input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importFromExcel(event)">
</div>
<div style="margin-top: 15px;">
<button class="btn" onclick="printPlanningReport()" style="background: #28a745;">ğŸ“„ Print Planning Report</button>
<button class="btn" onclick="downloadWordReport()" style="background: #0066cc; margin-left: 10px;">ğŸ“¥ Download Word Report</button>
<button class="btn" onclick="openChangeLog()" style="background: #ff9800; margin-left: 10px;">ğŸ“‹ View Change Log</button>
</div>
</div>
<div style="background: #f5f5f5; padding: 30px; border-radius: 10px;">
<div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
  <div style="flex: 1; min-width: 200px;">
    <label style="display: block; font-weight: bold; color: #2B7BBD; margin-bottom: 5px;">Search</label>
    <input type="text" id="adminSearch" placeholder="Search by title..." oninput="applyAdminFilters()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
  </div>
  <div style="min-width: 180px;">
    <label style="display: block; font-weight: bold; color: #2B7BBD; margin-bottom: 5px;">PACE Lead</label>
    <select id="adminFilterPaceLead" onchange="applyAdminFilters()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
      <option value="">All PACE Leads</option>
    </select>
  </div>
  <div style="min-width: 180px;">
    <label style="display: block; font-weight: bold; color: #2B7BBD; margin-bottom: 5px;">Calendar</label>
    <select id="adminFilterCalendar" onchange="applyAdminFilters()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
      <option value="all">All Events</option>
      <option value="notcalendar">Not on Calendar</option>
      <option value="oncalendar">On Calendar</option>
    </select>
  </div>
  <button class="btn btn-secondary" onclick="clearAdminFilters()" style="align-self: flex-end;">Clear</button>
</div>
<p style="font-size: 1.2em; margin-bottom: 20px; text-align: center;">Total Events: <strong id="eventCount">0</strong></p>
<div id="adminEventsList" style="display: grid; gap: 15px;"></div>
</div>
</div>
</div>
<!-- SECTION END: ADMIN PAGE -->

</div>
<!-- SECTION END: PAGE CONTENT CONTAINER -->

<!-- ============================================ -->
<!-- SECTION START: EVENT FORM MODAL -->
<!-- ============================================ -->
<!-- ============================================ -->
<!-- SECTION START: FESTIVAL ADMIN LOGIN MODAL -->
<!-- ============================================ -->
<div id="festivalAdminModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <span class="close" onclick="closeFestivalAdminModal()">&times;</span>
    <h2 style="text-align: center; color: #2B7BBD; margin-bottom: 20px;">Festival Admin Access</h2>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">Enter your password or access code</p>
    
    <div style="margin-bottom: 20px;">
      <input type="password" id="festivalAdminPassword" class="admin-input" placeholder="Password or Access Code" style="width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 8px;" onkeypress="if(event.key==='Enter') festivalAdminLogin()" autofocus>
    </div>
    
    <button class="btn" onclick="festivalAdminLogin()" style="width: 100%; padding: 15px; font-size: 1.1em;">Access Admin</button>
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #666;">
      <p style="margin-bottom: 10px;"><strong>Access Levels:</strong></p>
      <p style="margin-bottom: 5px;">â€¢ <strong>PACE Password</strong> - View events in planning</p>
      <p style="margin-bottom: 5px;">â€¢ <strong>Access Code</strong> - Manage your own events (My Events)</p>
      <p>â€¢ <strong>Admin Password</strong> - Full admin access</p>
    </div>
  </div>
</div>
<!-- SECTION END: FESTIVAL ADMIN LOGIN MODAL -->

<!-- ============================================ -->
<!-- SECTION START: EVENT MODAL -->
<!-- ============================================ -->
<div id="eventModal" class="modal">
<div class="modal-content">
<!-- Floating Jump to Save Button -->
<button id="jumpToSave" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
  background: #2B7BBD; color: white; border: none; padding: 12px 24px; 
  border-radius: 25px; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-size: 14px; cursor: pointer; font-weight: bold;">
  â†“ Jump to Save
</button>
<div class="modal-header">
<h2 id="modalTitle" style="color: #2B7BBD; margin: 0;">Add New Event</h2>
<button style="background: none; border: none; cursor: pointer; font-size: 1.5em;" onclick="closeEventForm()">Ã—</button>
</div>
<form id="eventForm" onsubmit="saveEvent(event)">
<div class="form-group" style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
  <label style="color: #2B7BBD; font-weight: bold;">Event ID</label>
  <input type="text" id="eventUniqueId" style="font-family: monospace; font-weight: bold;" placeholder="Enter Event ID (e.g., HH-EVENT01)">
  <small>This unique identifier tracks this event across updates</small>
</div>
<div class="form-group"><label>Event Title *</label><input type="text" id="eventTitle" required></div>
<div class="form-group"><label>Event Type</label>
<select id="eventType">
<option value="">Select a type...</option>
<option value="Workshop">Workshop</option>
<option value="Talk/Lecture">Talk/Lecture</option>
<option value="Performance">Performance</option>
<option value="Film Screening">Film Screening</option>
<option value="Music">Music</option>
<option value="Exhibition">Exhibition</option>
<option value="Debate">Debate</option>
<option value="Quiz">Quiz</option>
<option value="Activity">Activity</option>
<option value="Other">Other</option>
</select></div>
<div class="form-group"><label>Topic</label><input type="text" id="eventTopic" placeholder="e.g., Climate Change, Biodiversity"></div>
<div class="form-group"><label>Description *</label><textarea id="eventDescription" placeholder="Describe the event..." required></textarea></div>
<div class="form-group"><label>Short Summary *</label><input type="text" id="eventSummary" placeholder="Brief one-line summary" maxlength="120"><small>Keep it short - this appears on event lists (max 120 characters)</small></div>
<div class="two-col">
<div class="form-group"><label>Date</label><input type="date" id="eventDate" min="2026-05-23" max="2026-06-30" onchange="showTimeSlotsSection(); showRecurrenceSection();"></div>
<div class="form-group"><label>Time Start</label>
<div class="two-col">
<select id="eventTimeHour">
<option value="">Hour</option>
<option value="00">00</option>
<option value="01">01</option>
<option value="02">02</option>
<option value="03">03</option>
<option value="04">04</option>
<option value="05">05</option>
<option value="06">06</option>
<option value="07">07</option>
<option value="08">08</option>
<option value="09">09</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
<option value="16">16</option>
<option value="17">17</option>
<option value="18">18</option>
<option value="19">19</option>
<option value="20">20</option>
<option value="21">21</option>
<option value="22">22</option>
<option value="23">23</option>
</select>
<select id="eventTimeMinute">
<option value="">Min</option>
<option value="00">00</option>
<option value="15">15</option>
<option value="30">30</option>
<option value="45">45</option>
</select>
</div>
</div>
</div>
<div class="form-group">
  <label>Rough Week</label>
  <input type="text" id="eventRoughWeek" placeholder="e.g., Festival Week 2">
  <small>If exact date not known, enter the rough week</small>
</div>
<div class="form-group">
  <label>Rough Day</label>
  <input type="text" id="eventRoughDay" placeholder="e.g., Monday, Wednesday">
  <small>If exact date not known, which days of the week?</small>
</div>
<div class="form-group">
  <label>Rough Time</label>
  <input type="text" id="eventRoughTime" placeholder="e.g., Morning, Afternoon, Evening">
  <small>If exact time not known, rough time of day</small>
</div>
<div class="form-group"><label>Duration</label>
<div class="two-col">
<select id="eventDurationHours">
<option value="0">0 hours</option>
<option value="1">1 hour</option>
<option value="2">2 hours</option>
<option value="3">3 hours</option>
<option value="4">4 hours</option>
<option value="5">5 hours</option>
<option value="6">6 hours</option>
<option value="7">7 hours</option>
<option value="8">8 hours</option>
<option value="9">9 hours</option>
<option value="10">10 hours</option>
<option value="11">11 hours</option>
<option value="12">12 hours</option>
</select>
<select id="eventDurationMinutes">
<option value="0">0 minutes</option>
<option value="15">15 minutes</option>
<option value="30">30 minutes</option>
<option value="45">45 minutes</option>
</select>
</div>
</div>

<!-- TIME SLOTS SECTION -->
<div id="timeSlotsSection" style="margin-top: 15px; padding: 15px; background: #f0f7ff; border: 1px solid #cce0f5; border-radius: 8px; display: none;">
  <label style="font-weight: bold; color: #2B7BBD; display: block; margin-bottom: 8px;">â° Additional Time Slots</label>
  <small style="color: #666; display: block; margin-bottom: 10px;">This event runs multiple times on the same day. The time and duration above is the first slot. Add extra slots here.</small>
  <div id="timeSlotsList"></div>
  <button type="button" onclick="addTimeSlot()" style="margin-top: 10px; padding: 8px 16px; background: #2B7BBD; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">+ Add Another Slot</button>
</div>

<!-- RECURRENCE SECTION -->
<div id="recurrenceSection" style="margin-top: 15px; padding: 15px; background: #f0f7ff; border: 1px solid #cce0f5; border-radius: 8px; display: none;">
  <label style="font-weight: bold; color: #2B7BBD; display: block; margin-bottom: 8px;">ğŸ” Repeating Event</label>
  <small style="color: #666; display: block; margin-bottom: 10px;">The date above is the <strong>first occurrence</strong>. Set how this event repeats.</small>
  <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
    <label style="font-weight: bold; color: #333; min-width: 60px;">Repeat:</label>
    <select id="recurrenceType" onchange="updateRecurrenceUI()" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.95em;">
      <option value="none">No repeat</option>
      <option value="weekly">Weekly (on specific days)</option>
      <option value="daily">Every day</option>
    </select>
  </div>
  <div id="recurrenceDaysRow" style="display: none; margin-bottom: 10px;">
    <label style="font-weight: bold; color: #333; display: block; margin-bottom: 6px;">On these days:</label>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay1" value="1"> Mon</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay2" value="2"> Tue</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay3" value="3"> Wed</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay4" value="4"> Thu</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay5" value="5"> Fri</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay6" value="6"> Sat</label>
      <label style="display: flex; align-items: center; gap: 4px; background: #fff; border: 1px solid #ccc; border-radius: 20px; padding: 4px 10px; cursor: pointer; font-size: 0.9em;"><input type="checkbox" id="recDay0" value="0"> Sun</label>
    </div>
  </div>
  <div id="recurrenceEndRow" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
    <label style="font-weight: bold; color: #333;">Until:</label>
    <input type="date" id="recurrenceEndDate" min="2026-05-23" max="2026-06-30" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.95em;">
    <small style="color: #666;">(must be within the festival: 23 May â€“ 30 June)</small>
  </div>
</div>

<div class="two-col">
<div class="two-col">
<div class="form-group"><label>Location</label><input type="text" id="eventLocation" value="Manningtree"></div>
<div class="form-group"><label>Post Code</label><input type="text" id="eventPostcode" placeholder="e.g., CO11 1AA"></div>
</div>
<div class="form-group"><label>Venue</label><input type="text" id="eventVenue" placeholder="e.g., Community Hall"></div>
</div>
<div class="form-group"><label>Organisation *</label><input type="text" id="eventOrganiser" placeholder="Organisation or person organising the event" required></div>
<div class="form-group">
  <label>Organisation Website</label>
  <input type="url" id="organisationWebsite" placeholder="https://www.yourorganisation.org.uk">
  <small>Link to the organisation's website (optional)</small>
</div>
<div class="form-group">
  <label>About the Organisation</label>
  <textarea id="organisationAbout" placeholder="Tell us about the organisation hosting this event..."></textarea>
  <small>Information about the organisation - this helps promote their work!</small>
</div>
<div class="form-group">
  <label>Eventbrite Registration URL</label>
  <input type="url" id="eventbriteUrl" placeholder="https://www.eventbrite.co.uk/e/your-event-...">
  <small>Add the Eventbrite link for this event. Leave blank if no registration required.</small>
</div>

<h3 style="color: #2B7BBD; margin: 30px 0 15px 0; padding-top: 20px; border-top: 2px solid #eee;">Organizer Contact Information</h3>

<div class="two-col">
<div class="form-group"><label>Contact Name</label><input type="text" id="eventContactName" placeholder="Event organizer contact" required></div>
<div class="form-group"><label>Contact Email</label><input type="email" id="eventContactEmail" placeholder="contact@example.com"></div>
</div>

<div class="form-group"><label>Contact Phone</label><input type="tel" id="eventContactPhone" placeholder="e.g., 07771862595"></div>

<h3 style="color: #2B7BBD; margin: 30px 0 15px 0; padding-top: 20px; border-top: 2px solid #eee;">PACE Lead Information</h3>
<small style="display: block; margin-bottom: 15px; color: #666;">This information is visible to administrators and the PACE Lead</small>

<div class="form-group">
  <label>PACE Lead Name *</label>
  <input type="text" id="eventPaceLead" placeholder="PACE volunteer leading this event" required>
</div>

<div class="two-col">
<div class="form-group"><label>PACE Lead Email</label><input type="email" id="eventPaceLeadEmail" placeholder="pacelead@example.com" required></div>
<div class="form-group"><label>PACE Lead Phone</label><input type="tel" id="eventPaceLeadPhone" placeholder="e.g., 02562567567"></div>
</div>

<div class="form-group">
  <label>Planning Notes</label>
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <textarea id="eventNewNote" rows="3" placeholder="Add a new note..." style="flex: 1;"></textarea>
    <button type="button" onclick="addPlanningNote()" style="background: #28a745; color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; align-self: flex-end; white-space: nowrap;">+ Add Note</button>
  </div>
  <div id="planningNotesList" style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;"></div>
  <small>Notes are date-stamped and sorted latest first. Visible to all PACE Leads.</small>
</div>

<div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffc107;">
  <label style="font-weight: bold;">Access Code *</label>
  <input type="text" id="eventAccessCode" placeholder="e.g., HH1234" style="font-family: monospace; font-weight: bold; font-size: 1.1em;" onfocus="document.getElementById('accessCodeWarningText').style.display='block';">
  <small id="accessCodeWarningText" style="display: none; margin-top: 8px; line-height: 1.5;">
    <strong>âš ï¸ IMPORTANT:</strong> This code controls who can edit this event.<br>
    â€¢ To <strong>keep</strong> this event: Leave your Access Code here<br>
    â€¢ To <strong>transfer</strong> to another PACE Lead: Enter their Access Code<br>
    â€¢ Format: Initials + 4 digits (e.g., HH1234, SJ5678)
  </small>
</div>

<div class="form-actions">
<button type="button" class="btn btn-secondary" onclick="closeEventForm()">Cancel</button>
<button type="submit" class="btn">Save</button>
</div>
</form>
</div>
</div>
<!-- SECTION END: EVENT FORM MODAL -->
<!-- ============================================ -->
<!-- SECTION START: EVENT DETAIL MODAL -->
<!-- ============================================ -->
<div id="eventDetailModal" class="event-modal">
<div class="event-modal-content">
<div class="event-modal-header">
<button class="event-modal-close" onclick="closeEventDetailModal()">Ã—</button>
<h2 class="event-modal-title" id="eventDetailTitle"></h2>
<p class="event-modal-subtitle" id="eventDetailSubtitle"></p>
</div>
<div class="event-modal-body">
<div class="event-detail-grid" id="eventDetailGrid"></div>
<div class="event-description" id="eventDetailDescription"></div>
<div id="eventDetailExtra"></div>
<div class="event-modal-actions" id="eventDetailActions"></div>
</div>
</div>
</div>
<!-- SECTION END: EVENT DETAIL MODAL -->

<!-- ============================================ -->
<!-- SECTION START: CHANGE LOG MODAL -->
<!-- ============================================ -->
<div id="changeLogModal" class="modal">
<div class="modal-content" style="max-width: 900px;">
<div class="modal-header">
<h2 style="color: #2B7BBD; margin: 0;">ğŸ“‹ Change Log</h2>
<button style="background: none; border: none; cursor: pointer; font-size: 1.5em;" onclick="closeChangeLog()">Ã—</button>
</div>

<div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<p style="margin: 0; color: #666;">Track all changes made to events, notes, and venues. Most recent changes appear first.</p>
</div>

<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
  <input type="text" id="changeLogSearch" placeholder="Search changes..." style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;" oninput="filterChangeLog()">
  <select id="changeLogTypeFilter" onchange="filterChangeLog()" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
    <option value="all">All Types</option>
    <option value="added">Events Added</option>
    <option value="edited">Events Edited</option>
    <option value="deleted">Events Deleted</option>
    <option value="note">Notes Added</option>
    <option value="venue">Venue Changes</option>
  </select>
  <button class="btn btn-secondary" onclick="clearChangeLog()" style="padding: 10px 20px;">Clear Log</button>
</div>

<div id="changeLogList" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
  <p style="padding: 40px; text-align: center; color: #999;">Loading change log...</p>
</div>

<div style="margin-top: 20px; text-align: center;">
  <button class="btn btn-secondary" onclick="closeChangeLog()">Close</button>
</div>
</div>
</div>
<!-- SECTION END: CHANGE LOG MODAL -->

<!-- ============================================ -->
<!-- SECTION START: PRIDE MODAL -->
<!-- ============================================ -->
<div id="prideModal" class="pride-modal">
<div class="pride-modal-content">
<div class="pride-modal-header">
<h2 class="pride-modal-title">ğŸ³ï¸â€ğŸŒˆ Manningtree Pride ğŸ³ï¸â€ğŸŒˆ</h2>
</div>
<p style="font-size: 1.2em; margin-bottom: 20px; color: #333;">Join us for Manningtree Pride on <strong>6th June 2026</strong>!</p>
<p style="margin-bottom: 30px; color: #666; line-height: 1.6;">Manningtree Pride is happening on the same day as part of our Earth Festival celebration. Come together for a day of diversity, inclusion, and community spirit.</p>
<a href="https://www.manningtreepride.co.uk/" target="_blank" class="btn" style="display: inline-block; margin: 10px;">Visit Manningtree Pride Website</a>
<button class="btn btn-secondary" onclick="closePrideModal()" style="display: inline-block; margin: 10px;">Close</button>
</div>
</div>

<!-- ============================================ -->
<!-- SECTION START: VENUE FORM MODAL -->
<!-- ============================================ -->
<div id="venueModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="venueModalTitle" style="color: #2B7BBD; margin: 0;">Add New Venue</h2>
<button style="background: none; border: none; cursor: pointer; font-size: 1.5em;" onclick="closeVenueForm()">Ã—</button>
</div>
<form id="venueForm" onsubmit="saveVenue(event)">
<div class="form-group"><label>Venue Name *</label><input type="text" id="venueName" required></div>
<div class="form-group"><label>Location/Address</label><input type="text" id="venueAddress"></div>
<div class="form-group"><label>Postcode</label><input type="text" id="venuePostcode" placeholder="e.g., CO11 1AA"></div>
<div class="form-group"><label>Capacity (max people)</label><input type="number" id="venueCapacity" min="0" placeholder="e.g., 100"></div>
<div class="form-group">
  <label>Facilities</label>
  <textarea id="venueFacilities" rows="4" placeholder="e.g., Wheelchair access, Parking (20 spaces), Kitchen facilities, Projector & screen, WiFi"></textarea>
  <small>List key facilities and amenities</small>
</div>
<div class="form-group">
  <label>Availability Notes</label>
  <textarea id="venueAvailability" rows="3" placeholder="e.g., Not available Mondays, Closed for renovations 1-15 June"></textarea>
  <small>Note any dates/times when the venue is NOT available</small>
</div>
<div class="form-group"><label>Contact Person</label><input type="text" id="venueContact"></div>
<div class="form-group"><label>Contact Email</label><input type="email" id="venueContactEmail"></div>
<div class="form-group"><label>Contact Phone</label><input type="tel" id="venueContactPhone"></div>
<div class="form-group">
  <label>Notes</label>
  <textarea id="venueNotes" rows="4" placeholder="Any other useful information about this venue..."></textarea>
</div>
<div class="form-actions">
<button type="button" class="btn btn-secondary" onclick="closeVenueForm()">Cancel</button>
<button type="submit" class="btn">Save Venue</button>
</div>
</form>
</div>
</div>
<!-- SECTION END: VENUE FORM MODAL -->
<!-- ============================================ -->

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>

// Force scroll to top immediately on load/refresh - BEFORE anything else
if (history.scrollRestoration) {
  history.scrollRestoration = 'manual';
}

// Prevent hash-based scrolling
window.addEventListener('hashchange', function() {
  window.scrollTo(0, 0);
}, false);

// Immediate scroll
window.scrollTo(0, 0);

// Also scroll after a tiny delay to override any hash scrolling
setTimeout(() => {
  window.scrollTo(0, 0);
}, 1);

// Ensure all modals are hidden on load - belt and suspenders
document.addEventListener('DOMContentLoaded', function() {
  ['eventModal','eventDetailModal','prideModal'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.classList.remove('active');
  });
});

const firebaseConfig = {
  apiKey: 'AIzaSyD7j6aYeREVd_WMI_QBMZz1-cSrOB37WvU',
  authDomain: 'mef26-events.firebaseapp.com',
  projectId: 'mef26-events',
  storageBucket: 'mef26-events.firebasestorage.app',
  messagingSenderId: '1081449337728',
  appId: '1:1081449337728:web:37d39215722fcb4b01a765',
  databaseURL: 'https://mef26-events-default-rtdb.europe-west1.firebasedatabase.app'
};

let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log('Firebase initialized successfully');
} catch(e) {
  console.error('Firebase initialization failed:', e);
  alert('Firebase connection failed. Using local storage only.');
}

if (db !== null) {
  db.ref('.info/connected').on('value', function(snap) {
    if (snap.val() === true) {
      console.log('Connected to Firebase');
    } else {
      console.log('Disconnected from Firebase');
    }
  });
}
/* SECTION END: FIREBASE CONFIG */

/* ============================================ */
/* SECTION START: GLOBAL VARIABLES */
/* ============================================ */
let events = [];
let filteredEvents = [];
let venues = [];
let changeLog = [];
let filteredChangeLog = [];
let editingVenueId = null;
let isAdmin = false;
let isPaceLead = false;
let currentPaceLeadCode = null;
let editingEventId = null;
let tempEventNotes = []; // Temporary storage for notes when creating a new event
let useFirebase = db !== null;
let currentCalendarView = 'month';
let currentCalendarDate = new Date('2026-06-01');

/* SECTION END: GLOBAL VARIABLES */

/* ============================================ */
/* SECTION START: PAGE NAVIGATION */
/* ============================================ */
function showPage(pageName, btn) {
  // Scroll to top immediately
  window.scrollTo(0, 0);
  
  // Add to browser history (so back button works)
  if(window.location.hash !== '#' + pageName) {
    history.pushState({page: pageName}, '', '#' + pageName);
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(pageName).classList.add('active');
  if(btn) btn.classList.add('active');
  if(pageName==='events'){ 
    clearFilters();
    document.getElementById('filtersPanel').style.display='none';
    document.getElementById('filterToggle').textContent='Show Filters';
    renderEvents(); 
    populateFilters(); 
  }
  if(pageName==='calendar'){ renderCalendar(); }
  if(pageName==='home'){ 
    isAdmin=false;
    isPaceLead=false;
    currentPaceLeadCode=null;
    document.getElementById('adminLogin').style.display='block'; 
    document.getElementById('adminPanel').style.display='none';
    document.getElementById('adminPassword').value='';
  }
  if(pageName==='paceplanning'){ 
    if(isPaceLead || isAdmin) {
      // Already logged in - go straight to panel
      document.getElementById('pacePlanningLogin').style.display='none'; 
      document.getElementById('pacePlanningPanel').style.display='block';
      renderPlanningEvents();
    } else {
      // Not logged in - show login
      document.getElementById('pacePlanningLogin').style.display='block'; 
      document.getElementById('pacePlanningPanel').style.display='none';
      document.getElementById('pacePlanningPassword').value='';
      setTimeout(() => document.getElementById('pacePlanningPassword').focus(), 100);
    }
  }
  if(pageName==='admin'){ 
    if(isAdmin) {
      // Already logged in as admin - go straight to panel
      document.getElementById('adminLogin').style.display='none'; 
      document.getElementById('adminPanel').style.display='block';
      renderAdminEventsList();
    } else {
      // Not logged in - show login
      document.getElementById('adminLogin').style.display='block'; 
      document.getElementById('adminPanel').style.display='none';
      document.getElementById('adminPassword').value='';
      setTimeout(() => document.getElementById('adminPassword').focus(), 100);
    }
  }
 if(pageName==='paceleadportal'){ 
    if(currentPaceLeadCode) {
      // Already logged in - go straight to panel
      document.getElementById('paceLeadLogin').style.display='none'; 
      document.getElementById('paceLeadPanel').style.display='block';
      renderPaceLeadEvents();
    } else {
      // Not logged in - show login
      document.getElementById('paceLeadLogin').style.display='block'; 
      document.getElementById('paceLeadPanel').style.display='none';
      document.getElementById('paceLeadCode').value='';
      setTimeout(() => document.getElementById('paceLeadCode').focus(), 100);
    }
  }
}

window.onload = function() {
  loadEvents();
  loadVenues();
  loadChangeLog();
  showPage('home');
  
  // Update load time display
  if(document.getElementById('loadTime')) {
    document.getElementById('loadTime').textContent = new Date().toLocaleString('en-GB', {
      day: '2-digit',
      month: 'short', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }
};
/* SECTION END: PAGE NAVIGATION */

/* ============================================ */
/* SECTION START: DATA LOAD/SAVE */
/* ============================================ */
function loadEvents() {
  if(useFirebase && db) {
    // Use .once() instead of .on() to load data without realtime sync
    // Realtime sync was causing issues when editing - would overwrite local changes
    db.ref('events').once('value', function(snapshot) {
      if(snapshot.exists()) {
        const data = snapshot.val();
        events = Object.values(data);
        // Ensure all planningNotes are properly formatted as arrays
        events.forEach(e => {
          if(e.planningNotes && !Array.isArray(e.planningNotes)) {
            e.planningNotes = migrateNotes(e.planningNotes);
          }
        });
      } else {
        events = [];
      }
      filteredEvents = [...events];
      document.getElementById('eventCount').textContent = events.length;
      renderEvents();
      renderCalendar();
      renderAdminEventsList();
    });
  } else {
    const stored = localStorage.getItem('mef-events');
    if(stored){ events = JSON.parse(stored); }
    filteredEvents = [...events];
    document.getElementById('eventCount').textContent = events.length;
  }
}

function saveEvents() {
  if(useFirebase && db) {
    const eventsObj = {};
    // Use uniqueId as the Firebase key so events are identifiable in the console
    // Fallback to timestamp ID if uniqueId is missing
    events.forEach((e, idx) => { 
      const key = e.uniqueId || e.id;
      // Ensure planningNotes are properly formatted before saving
      if(e.planningNotes && !Array.isArray(e.planningNotes)) {
        e.planningNotes = migrateNotes(e.planningNotes);
      }
      eventsObj[key] = e; 
    });
    // Use update instead of set to prevent data loss
    db.ref('events').update(eventsObj).catch(err => console.error('Firebase save error:', err));
  } else {
    localStorage.setItem('mef-events', JSON.stringify(events));
  }
  filteredEvents = [...events];
  document.getElementById('eventCount').textContent = events.length;
}
/* SECTION END: DATA LOAD/SAVE */

/* ============================================ */
/* SECTION START: FILTER FUNCTIONS */
/* ============================================ */
function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const type = document.getElementById('typeFilter').value;
  const loc = document.getElementById('locationFilter').value;
  const date = document.getElementById('dateFilter').value;
  filteredEvents = events.filter(e=>{
    // Only show events that have a date on the Events page
    const hasDate = e.date && e.date !== '';
    return hasDate &&
           (!search || e.title.toLowerCase().includes(search)) &&
           (!type || e.type===type) &&
           (!loc || (e.location && e.location===loc)) &&
           (!date || e.date===date);
  });
  renderEvents();
}

function clearFilters() {
  document.getElementById('searchInput').value='';
  document.getElementById('typeFilter').value='';
  document.getElementById('locationFilter').value='';
  document.getElementById('dateFilter').value='';
  applyFilters();
}

function toggleFilters() {
  const panel = document.getElementById('filtersPanel');
  const btn = document.getElementById('filterToggle');
  if(panel.style.display === 'none') {
    panel.style.display = 'block';
    btn.textContent = 'Hide Filters';
  } else {
    panel.style.display = 'none';
    btn.textContent = 'Show Filters';
  }
}

function populateFilters() {
  const types = [...new Set(events.map(e=>e.type).filter(Boolean))];
  const locations = [...new Set(events.map(e=>e.location).filter(Boolean))];
  const typeFilter = document.getElementById('typeFilter'); 
  typeFilter.innerHTML='<option value="">All Types</option>';
  types.forEach(t=>{ 
    let opt=document.createElement('option'); 
    opt.value=t; 
    opt.textContent=t; 
    typeFilter.appendChild(opt); 
  });
  const locFilter = document.getElementById('locationFilter'); 
  locFilter.innerHTML='<option value="">All Locations</option>';
  locations.forEach(l=>{ 
    let opt=document.createElement('option'); 
    opt.value=l; 
    opt.textContent=l; 
    locFilter.appendChild(opt); 
  });
}
/* SECTION END: FILTER FUNCTIONS */

/* ============================================ */
/* SECTION START: FORMATTING FUNCTIONS */
/* ============================================ */
function formatDate(dateStr) {
  if(!dateStr) return '';
  const date = new Date(dateStr + 'T00:00:00');
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatDuration(minutes) {
  if(!minutes) return '';
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if(hours > 0 && mins > 0) return `${hours}h ${mins}m`;
  if(hours > 0) return `${hours}h`;
  return `${mins}m`;
}

function parseTimeString(timeStr) {
  if(!timeStr) return '';
  
  // Match formats like "5:00 PM", "17:00", "5 PM", etc.
  const match = timeStr.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
  if(!match) return '';
  
  let hours = parseInt(match[1]);
  let minutes = match[2] ? parseInt(match[2]) : 0;
  const meridian = match[3] ? match[3].toUpperCase() : null;
  
  // Convert PM/AM to 24-hour format
  if(meridian === 'PM' && hours < 12) hours += 12;
  if(meridian === 'AM' && hours === 12) hours = 0;
  
  return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
}
/* SECTION END: FORMATTING FUNCTIONS */

/* ============================================ */
/* SECTION START: EVENT RENDERING */
/* ============================================ */
function renderEvents() {
  const container = document.getElementById('eventsList');
  container.innerHTML='';
  if(filteredEvents.length===0){ 
    container.innerHTML='<p style="text-align: center; padding: 40px; color: #666;">No events found.</p>'; 
    return; 
  }

  if(filteredEvents.length > 1) {
    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666; font-size: 1.1em; font-style: italic;">Click on any event to find out more and book your place</p>';
  }

  filteredEvents.forEach((e,i)=>{
    let div = document.createElement('div');
    div.className='event-card';
    div.onclick = () => showEventDetailModal(e.id);

    // Alternate colors: orange (color-1) and green (color-2)
    const colorClass = (i % 2 === 0) ? 'color-orange' : 'color-green';

    // Build timing info for line 1
    let timingParts = [];
    if(e.date) timingParts.push('ğŸ“… ' + formatDate(e.date));
    if(e.time) {
      const allSlots = getAllTimeSlots(e);
      if(allSlots.length > 1) {
        timingParts.push('ğŸ•’ ' + allSlots.length + ' sessions');
      } else {
        timingParts.push('ğŸ•’ ' + e.time);
      }
    }
    if(e.duration && e.duration > 0) {
      const hours = Math.floor(e.duration / 60);
      const mins = e.duration % 60;
      let durationStr = 'â±ï¸ ';
      if(hours > 0) durationStr += hours + (hours === 1 ? ' hour' : ' hours');
      if(mins > 0) durationStr += (hours > 0 ? ' ' : '') + mins + ' mins';
      timingParts.push(durationStr);
    }

    // Build location info for line 2
    let locationStr = '';
    if(e.location) {
      locationStr = 'ğŸ“ ' + e.location;
      if(e.postcode) locationStr += ', ' + e.postcode;
    } else if(e.venue) {
      locationStr = 'ğŸ“ ' + e.venue;
      if(e.postcode) locationStr += ', ' + e.postcode;
    }

    // Get description (summary or shortened description)
    let description = '';
    if(e.summary) {
      description = e.summary;
    } else if(e.description) {
      description = e.description.length > 120 ? e.description.substring(0, 120) + '...' : e.description;
    }

    let html = `
    <div class="event-card-header ${colorClass}">${e.title}</div>
    <div class="event-card-body">`;
    
    if(timingParts.length > 0) {
      html += `<div class="event-card-info">${timingParts.join('  ')}</div>`;
    }
    
    if(locationStr) {
      html += `<div class="event-card-info">${locationStr}</div>`;
    }

    // Show time slots box if multiple sessions
    const weekSlots = getAllTimeSlots(e);
    if(weekSlots.length > 1) {
      html += `<div style="margin: 10px 0; padding: 8px 12px; background: #e8f4fd; border-radius: 6px; border-left: 3px solid #2B7BBD; font-size: 0.9em;">`;
      html += `<div style="font-weight: bold; color: #2B7BBD; margin-bottom: 4px;">â° ${weekSlots.length} sessions:</div>`;
      weekSlots.forEach(slot => {
        html += `<div style="color: #333; padding: 2px 0;">${formatSlotTime(slot)}</div>`;
      });
      html += `</div>`;
    }
    
    if(description) {
      html += `<div class="event-card-description">${description}</div>`;
    }

    html += `<div class="event-card-cta">Click for details â†’</div>`;
    html += `</div>`;

    div.innerHTML = html;
    container.appendChild(div);
  });
}
/* SECTION END: EVENT RENDERING */

/* ============================================ */
/* SECTION START: CALENDAR FUNCTIONS */
/* ============================================ */

function showCalendarView(view) {
  currentCalendarView = view;
  renderCalendar();
}

function renderCalendar() {
  const container = document.getElementById('calendarViewContainer');
  
  if(currentCalendarView === 'month') {
    renderMonthView(container);
  } else if(currentCalendarView === 'week') {
    renderWeekView(container);
  } else if(currentCalendarView === 'day') {
    renderDayView(container);
  }
}

function renderMonthView(container) {
  const startDate = new Date('2026-05-23');
  const endDate = new Date('2026-06-30');
  
  let html = '<div style="text-align: center; margin-bottom: 20px;"><h3 style="color: #2B7BBD; margin: 0;">May - June</h3></div>';
  html += '<div class="calendar-grid">';
  
  let currentDate = new Date(startDate);
  let currentMonth = '';
  
  while(currentDate <= endDate) {
    const dateStr = currentDate.toISOString().split('T')[0];
    const dayEvents = getEventsOnDate(dateStr);
    const dayNum = currentDate.getDate();
    const monthName = currentDate.toLocaleString('default', { month: 'short' });
    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
    const isPrideDay = dateStr === '2026-06-06';
    
    // Add month header when month changes
    if(monthName !== currentMonth) {
      currentMonth = monthName;
      html += `<div style="grid-column: 1 / -1; font-weight: bold; color: #8DC63F; padding: 10px; text-align: center; font-size: 1.1em; background: #f5f5f5; border-radius: 8px; margin: 5px 0;">${monthName}</div>`;
    }
    
    html += `<div class="calendar-day${dayEvents.length>0?' has-events':''}"${dayEvents.length>0?' onclick="showDayEvents(\''+dateStr+'\')"':''}>
      <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
        <div style="font-size: 1em; font-weight: bold;">${dayName}</div>
        <div class="calendar-day-number" style="font-size: 1em;">${dayNum}</div>
      </div>
      ${isPrideDay?'<div class="pride-banner" onclick="event.stopPropagation(); showPrideModal();"><div class="pride-banner-text">ğŸ³ï¸â€ğŸŒˆ Pride</div></div>':''}
      ${dayEvents.length>0?'<div class="event-count">'+dayEvents.length+'</div>':''}
    </div>`;
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function renderWeekView(container) {
  const startOfWeek = new Date(currentCalendarDate);
  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
  
  const weekStart = new Date(startOfWeek);
  const weekEnd = new Date(startOfWeek);
  weekEnd.setDate(weekEnd.getDate() + 6);
  
  const weekStartStr = weekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  const weekEndStr = weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  
  let html = '<div style="max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; padding: 0 10px;">';
  html += '<div class="week-header">' + weekStartStr + ' - ' + weekEndStr + '</div>';
  html += '<div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">';
  html += '<button class="btn" onclick="changeWeek(-1)" style="padding: 10px 20px;">â† Previous</button>';
  html += '<button class="btn" onclick="changeWeek(1)" style="padding: 10px 20px;">Next â†’</button>';
  html += '</div><div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; width: 100%;">';
  
  for(let i=0; i<7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(date.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    const dayEvents = getEventsOnDate(dateStr);
    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
    const dayNum = date.getDate();
    
    const hasEvents = dayEvents.length > 0;
    const minHeight = hasEvents ? '200px' : '80px';
    
    html += `<div style="border: 2px solid #8DC63F; border-radius: 10px; padding: 15px; min-height: ${minHeight}; background: white; min-width: 0; box-sizing: border-box;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <div style="font-size: 1.8em; color: #2B7BBD; font-weight: bold; line-height: 1;">${dayNum}</div>
        <div style="font-weight: bold; color: #666; font-size: 0.9em;">${dayName}</div>
      </div>`;
    
    dayEvents.forEach(ev => {
      const recIndicator = (ev.recurrence && ev.recurrence.type !== 'none') ? ' ğŸ”' : '';
      html += `<div style="background: #8DC63F; color: white; padding: 8px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9em; cursor: pointer; word-wrap: break-word;" onclick="showEventDetails(${ev.id})">
        ${ev.time || ''} ${ev.title}${recIndicator}
      </div>`;
    });
    
    html += '</div>';
  }
  
  html += '</div></div>';
  container.innerHTML = html;
}

function renderDayView(container) {
  const dateStr = currentCalendarDate.toISOString().split('T')[0];
  const dayEvents = getEventsOnDate(dateStr);
  
  let html = '<div style="max-width: 800px; margin: 0 auto;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;">';
  html += '<button class="btn" onclick="changeDay(-1)" style="padding: 10px 20px;">â† Previous</button>';
  html += '<h3 style="color: #2B7BBD; margin: 0;">' + currentCalendarDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' }) + '</h3>';
  html += '<button class="btn" onclick="changeDay(1)" style="padding: 10px 20px;">Next â†’</button>';
  html += '</div>';
  
  if(dayEvents.length === 0) {
    html += '<p style="text-align: center; color: #666; padding: 40px;">No events scheduled for this day.</p>';
  } else {
    if(dayEvents.length > 1) {
      html += '<p style="text-align: center; padding: 20px; color: #666; font-size: 1.1em; font-style: italic;">Click on any event to find out more and book your place</p>';
    }
    
    dayEvents.forEach(e => {
      let metaInfo = [];
      if(e.date) metaInfo.push(formatDate(e.date));
      if(e.time && !(e.timeSlots && e.timeSlots.length > 0)) metaInfo.push(e.time);
      if(e.duration && !(e.timeSlots && e.timeSlots.length > 0)) metaInfo.push(formatDuration(e.duration));
      const dayRecStr = formatRecurrence(e);
      if(dayRecStr) metaInfo.push('ğŸ” ' + dayRecStr);
      
      html += `<div class="event-card" style="cursor: pointer;" onclick="showEventDetailModal(${e.id})">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <h3 class="event-title" style="margin: 0 0 10px 0;">${e.title}</h3>
            <div class="event-meta" style="margin-bottom: 10px;">${metaInfo.join(' â€¢ ')}</div>`;
      
      // Time slots display
      const allSlots = getAllTimeSlots(e);
      if(allSlots.length > 1) {
        html += `<div style="margin: 10px 0; padding: 8px 12px; background: #e8f4fd; border-radius: 6px; border-left: 3px solid #2B7BBD;">`;
        html += `<div style="font-weight: bold; color: #2B7BBD; margin-bottom: 4px; font-size: 0.9em;">â° ${allSlots.length} sessions available:</div>`;
        allSlots.forEach(slot => {
          html += `<div style="color: #333; font-size: 0.9em; padding: 2px 0;">${formatSlotTime(slot)}</div>`;
        });
        html += `</div>`;
      }
      
      if(e.summary) {
        html += `<p style="margin: 10px 0 0 0; line-height: 1.4; color: #333;">${e.summary}</p>`;
      } else if(e.description) {
        const shortDesc = e.description.length > 100 ? e.description.substring(0, 100) + '...' : e.description;
        html += `<p style="margin: 10px 0 0 0; line-height: 1.4; color: #333;">${shortDesc}</p>`;
      }
      
      html += `</div>
          <div style="color: #8DC63F; font-weight: bold; font-size: 1.1em;">Click for details â†’</div>
        </div>
      </div>`;
    });
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function changeWeek(direction) {
  currentCalendarDate.setDate(currentCalendarDate.getDate() + (direction * 7));
  renderCalendar();
}

function changeDay(direction) {
  currentCalendarDate.setDate(currentCalendarDate.getDate() + direction);
  renderCalendar();
}

function showDayEvents(dateStr) {
  currentCalendarDate = new Date(dateStr + 'T12:00:00');
  showCalendarView('day');
}

function showEventDetails(id) {
  showEventDetailModal(id);
}
/* SECTION END: CALENDAR FUNCTIONS */

/* END OF PART 3A - Continue to Part 4 for remaining JavaScript */

/* MEF 2026 Index.html - PART 4 OF 4 (FINAL) */
/* JAVASCRIPT FUNCTIONS - PART B */

/* ============================================ */
/* SECTION START: ADMIN FUNCTIONS */
/* ============================================ */
function populateAdminPaceLeadFilter() {
  const select = document.getElementById('adminFilterPaceLead');
  if(!select) return;
  const currentVal = select.value;
  const leads = [...new Set(events.map(e => e.paceLead).filter(Boolean))].sort();
  select.innerHTML = '<option value="">All PACE Leads</option>';
  leads.forEach(lead => {
    select.innerHTML += '<option value="' + lead + '">' + lead + '</option>';
  });
  if(leads.includes(currentVal)) select.value = currentVal;
}

function applyAdminFilters() {
  const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
  const paceLeadFilter = document.getElementById('adminFilterPaceLead').value;
  const calendarFilter = document.getElementById('adminFilterCalendar').value;
  
  // Store filtered list for renderAdminEventsList to use
  adminFilteredEvents = events.filter(e => {
    if(searchTerm && !e.title.toLowerCase().includes(searchTerm)) return false;
    if(paceLeadFilter && e.paceLead !== paceLeadFilter) return false;
    const isOnCalendar = e.date && e.date !== '';
    if(calendarFilter === 'oncalendar' && !isOnCalendar) return false;
    if(calendarFilter === 'notcalendar' && isOnCalendar) return false;
    return true;
  });
  
  renderAdminEventsList();
}

function clearAdminFilters() {
  document.getElementById('adminSearch').value = '';
  document.getElementById('adminFilterPaceLead').value = '';
  document.getElementById('adminFilterCalendar').value = 'all';
  adminFilteredEvents = null;
  renderAdminEventsList();
}

let adminFilteredEvents = null;

function renderAdminEventsList() {
  populateAdminPaceLeadFilter();
  const container = document.getElementById('adminEventsList');
  container.innerHTML='';
  const sourceEvents = adminFilteredEvents !== null ? adminFilteredEvents : events;
  
  console.log('=== Rendering Admin Events List ===');
  console.log('Total events in database:', events.length);
  console.log('Events to display:', sourceEvents.length);
  console.log('Events being rendered:');
  sourceEvents.forEach((e, idx) => {
    console.log(`  [${idx}] ID: ${e.id}, Title: "${e.title}", PACE Lead: ${e.paceLead || 'none'}`);
  });
  
  if(sourceEvents.length===0){ 
    container.innerHTML='<p style="text-align: center; color: #666; padding: 20px;">' + (events.length === 0 ? 'No events yet. Click Add New Event to create one.' : 'No events match your search.') + '</p>'; 
    document.getElementById('eventCount').textContent = '0';
    return; 
  }
  document.getElementById('eventCount').textContent = sourceEvents.length + (adminFilteredEvents !== null && events.length !== sourceEvents.length ? ' of ' + events.length : '');
  const sortedEvents = [...sourceEvents].sort((a,b) => {
    // If both have dates, sort by date/time
    if(a.date && b.date) {
      if(a.date !== b.date) return a.date > b.date ? 1 : -1;
      return a.time > b.time ? 1 : -1;
    }
    // If only one has a date, put dated events first
    if(a.date && !b.date) return -1;
    if(!a.date && b.date) return 1;
    // If neither has a date, sort alphabetically by title
    return a.title.localeCompare(b.title);
  });
  sortedEvents.forEach((e)=>{
    let div = document.createElement('div');
    div.className='admin-event-item';
    
    const isOnCalendar = e.date && e.date !== '';
    const borderColour = isOnCalendar ? '#4CAF50' : '#FFA500';
    const badgeBg = isOnCalendar ? '#4CAF50' : '#FFA500';
    const badgeText = isOnCalendar ? 'ON CALENDAR' : 'IN PLANNING';
    div.style.borderLeftColor = borderColour;
    
    let metaInfo = [];
    if(e.type) metaInfo.push(e.type);
    if(e.date) metaInfo.push(formatDate(e.date));
    if(e.time) {
      const allSlots = getAllTimeSlots(e);
      if(allSlots.length > 1) {
        metaInfo.push('â° ' + allSlots.length + ' slots');
      } else {
        metaInfo.push(e.time);
      }
    }
    const recStr = formatRecurrence(e);
    if(recStr) metaInfo.push('ğŸ” ' + recStr);
    let html = '<div class="admin-event-info">';
    html += '<div style="display: inline-block; background: ' + badgeBg + '; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-bottom: 6px;">' + badgeText + '</div>';
    html += '<h3 class="admin-event-title">'+e.title+'</h3>';
    if(metaInfo.length>0) html += '<p class="admin-event-meta">'+metaInfo.join(' â€¢ ')+'</p>';
    if(e.summary) html += '<p class="admin-event-meta" style="font-style: italic; color: #555;">'+e.summary+'</p>';
    if(e.location) html += '<p class="admin-event-meta">Location: '+e.location+'</p>';
    if(e.venue) html += '<p class="admin-event-meta">Venue: '+e.venue+'</p>';
    if(e.organiser) html += '<p class="admin-event-meta">Organiser: '+e.organiser+'</p>';
    if(e.paceLead) html += '<p class="admin-event-meta">PACE Lead: '+e.paceLead+'</p>';
    
    // Planning Notes - scrollable box, clickable to open at notes section
    const adminNotes = migrateNotes(e.planningNotes);
    if(adminNotes.length > 0) {
      html += '<div onclick="editEvent(' + e.id + ', true); event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
      html += '<div style="padding: 10px 15px 5px 15px;"><strong style="color: #856404;">ğŸ“ Planning Notes</strong>' + (adminNotes.length > 1 ? ' <span style="color: #999; font-size: 0.85em;">(' + adminNotes.length + ' notes)</span>' : '') + '</div>';
      html += '<div style="max-height: 150px; overflow-y: auto; padding: 0 15px 12px 15px;">';
      adminNotes.forEach(function(note, i) {
        const nDateStr = note.date ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'No date';
        html += '<div style="padding: 8px 0; ' + (i < adminNotes.length - 1 ? 'border-bottom: 1px dashed #ddd;' : '') + '">';
        html += '<span style="font-size: 0.8em; color: #856404; font-weight: bold;">' + nDateStr + '</span>';
        html += '<p style="margin: 4px 0 0 0; white-space: pre-wrap; line-height: 1.4;">' + note.text + '</p>';
        html += '</div>';
      });
      html += '</div></div>';
    } else {
      html += '<div onclick="editEvent(' + e.id + ', true); event.stopPropagation();" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #dee2e6; border-radius: 5px; cursor: pointer;">';
      html += '<em style="color: #6c757d; font-size: 0.9em;">ğŸ“ No planning notes yet. Click here to open and add notes.</em>';
      html += '</div>';
    }
    
    html += '</div><div class="admin-event-actions">';
    html += '<button class="btn-edit" onclick="editEvent(' + e.id + ')">Edit</button>';
    html += '<button class="btn-data" onclick="copyEventData(' + e.id + ')">Data</button>';
    html += '<button class="btn-delete" onclick="console.log(\'Delete clicked for ID:\', ' + e.id + ', \'Title:\', \'' + e.title.replace(/'/g, "\\'") + '\'); deleteEvent(' + e.id + ')">Delete</button>';
    html += '</div>';
    div.innerHTML = html;
    container.appendChild(div);
  });
}

function editEvent(id, scrollToNotes = false) {
  const event = events.find(e=>e.id===id);
  if(event) {
    openEventForm(event);
    
    // Scroll to Planning Notes section if requested
    if(scrollToNotes) {
      setTimeout(() => {
        const modalContent = document.querySelector('#eventModal .modal-content');
        const planningNotesField = document.getElementById('planningNotesList');
        if(modalContent && planningNotesField) {
          const modalRect = modalContent.getBoundingClientRect();
          const notesRect = planningNotesField.getBoundingClientRect();
          modalContent.scrollTop += (notesRect.top - modalRect.top) - 80;
        }
      }, 100);
    }
  }
}

function deleteEvent(id) {
  console.log('deleteEvent called with ID:', id);
  const eventToDelete = events.find(e => e.id === id);
  console.log('Event found:', eventToDelete ? eventToDelete.title : 'NOT FOUND');
  
  if(!eventToDelete) {
    alert('Error: Event not found in database');
    return;
  }
  
  if(confirm('Are you sure you want to delete "' + eventToDelete.title + '"?')) {
    console.log('User confirmed deletion');
    
    // Log before deleting so we still have the event data
    addChangeLogEntry('deleted', 'Event deleted: ' + eventToDelete.title, {
      changes: 'Event permanently removed'
    }, eventToDelete);
    
    // Remove from events array
    const beforeLength = events.length;
    events = events.filter(e=>e.id!==id);
    console.log('Events array: was', beforeLength, 'now', events.length);
    
    // Remove from Firebase if using Firebase
    if(useFirebase && db) {
      const key = eventToDelete.uniqueId || eventToDelete.id;
      console.log('Removing from Firebase with key:', key);
      db.ref('events/' + key).remove()
        .then(() => console.log('Firebase delete successful'))
        .catch(err => {
          console.error('Firebase delete error:', err);
          alert('Warning: Event removed locally but Firebase delete failed. Please refresh and try again.');
        });
    }
    
    // Save the updated events array (for localStorage and to update filteredEvents)
    saveEvents();
    
    // Show toast instead of alert
    showToast('âœ“ Event deleted successfully');
    
    // Refresh the view based on current mode - CHECK ADMIN FIRST
    if(isAdmin) {
      // Reset filtered events to null to force fresh data, then re-apply filters if needed
      const hadFilters = adminFilteredEvents !== null;
      adminFilteredEvents = null;
      
      if(hadFilters) {
        // Re-apply the filters to get fresh filtered data
        applyAdminFilters();
      } else {
        // Just render with all events
        renderAdminEventsList();
      }
    } else if(isPaceLead && !currentPaceLeadCode) {
      // In PACE Planning mode
      applyPlanningFilters();
    } else if(currentPaceLeadCode) {
      // In PACE Lead My Events view
      renderPaceLeadEvents();
    } else {
      // Public view
      renderEvents();
      renderCalendar();
    }
  } else {
    console.log('User cancelled deletion');
  }
}

function copyEventData(id) {
  const event = events.find(e=>e.id===id);
  if(!event) {
    alert('Event not found');
    return;
  }
  
  // Helper to format field value
  const formatField = (value) => {
    if(value === undefined || value === null || value === '') return '[NEEDS COMPLETING]';
    return value;
  };
  
  // Build the formatted text
  let text = 'EVENT DETAILS FOR: ' + event.title + '\n';
  text += '='.repeat(50) + '\n\n';
  
  text += 'Unique ID: ' + formatField(event.uniqueId) + '\n';
  text += 'Title: ' + formatField(event.title) + '\n';
  text += 'Type: ' + formatField(event.type) + '\n';
  text += 'Topic: ' + formatField(event.topic) + '\n';
  text += 'Description: ' + formatField(event.description) + '\n';
  text += 'Summary: ' + formatField(event.summary) + '\n\n';
  
  text += 'DATE & TIME\n';
  text += '-'.repeat(50) + '\n';
  text += 'Date: ' + formatField(event.date) + '\n';
  text += 'Time: ' + formatField(event.time) + '\n';
  text += 'Duration: ' + (event.duration ? Math.floor(event.duration/60) + ' hours ' + (event.duration%60) + ' minutes' : '[NEEDS COMPLETING]') + '\n';
  text += 'Rough Week: ' + formatField(event.roughWeek) + '\n';
  text += 'Rough Day: ' + formatField(event.roughDay) + '\n';
  text += 'Rough Time: ' + formatField(event.roughTime) + '\n\n';
  
  text += 'LOCATION\n';
  text += '-'.repeat(50) + '\n';
  text += 'Location: ' + formatField(event.location) + '\n';
  text += 'Postcode: ' + formatField(event.postcode) + '\n';
  text += 'Venue: ' + formatField(event.venue) + '\n\n';
  
  text += 'ORGANISER DETAILS\n';
  text += '-'.repeat(50) + '\n';
  text += 'Organiser: ' + formatField(event.organiser) + '\n';
  text += 'Contact Name: ' + formatField(event.contactName) + '\n';
  text += 'Contact Email: ' + formatField(event.contactEmail) + '\n';
  text += 'Contact Phone: ' + formatField(event.contactPhone) + '\n\n';
  
  text += 'PACE LEAD DETAILS\n';
  text += '-'.repeat(50) + '\n';
  text += 'PACE Lead: ' + formatField(event.paceLead) + '\n';
  text += 'PACE Lead Email: ' + formatField(event.paceLeadEmail) + '\n';
  text += 'PACE Lead Phone: ' + formatField(event.paceLeadPhone) + '\n';
  text += 'Access Code: ' + formatField(event.accessCode) + '\n\n';
  
  text += 'LINKS & INFORMATION\n';
  text += '-'.repeat(50) + '\n';
  text += 'Eventbrite URL: ' + formatField(event.eventbriteUrl) + '\n';
  text += 'Organisation Website: ' + formatField(event.organisationWebsite) + '\n';
  text += 'Organisation About: ' + formatField(event.organisationAbout) + '\n\n';
  
  // Add planning notes if they exist
  const notes = migrateNotes(event.planningNotes || []);
  if(notes.length > 0) {
    text += 'PLANNING NOTES\n';
    text += '-'.repeat(50) + '\n';
    notes.forEach((note, i) => {
      const dateStr = note.date ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'No date';
      text += (i + 1) + '. [' + dateStr + '] ' + note.text + '\n';
    });
    text += '\n';
  }
  
  text += '='.repeat(50) + '\n';
  text += 'Generated: ' + new Date().toLocaleString('en-GB') + '\n';
  
  // Copy to clipboard
  navigator.clipboard.writeText(text).then(() => {
    showToast('âœ“ Event data copied to clipboard!');
  }).catch(err => {
    // Fallback if clipboard API fails
    alert('Could not copy automatically. Please copy manually:\n\n' + text);
  });
}


function login() {
  const pass = document.getElementById('adminPassword').value;
  if(pass==='ha!ford'){ 
    isAdmin=true;
    isPaceLead=true;
    document.getElementById('adminLogin').style.display='none'; 
    document.getElementById('adminPanel').style.display='block'; 
    renderAdminEventsList(); 
  } else{ 
    alert('Incorrect password'); 
  }
}

/* ============================================ */
/* UNIFIED FESTIVAL ADMIN LOGIN */
/* ============================================ */
function openFestivalAdminModal() {
  document.getElementById('festivalAdminModal').style.display = 'block';
  setTimeout(() => document.getElementById('festivalAdminPassword').focus(), 100);
}

function closeFestivalAdminModal() {
  document.getElementById('festivalAdminModal').style.display = 'none';
  document.getElementById('festivalAdminPassword').value = '';
}

function festivalAdminLogin() {
  const input = document.getElementById('festivalAdminPassword').value.trim();
  
  if(!input) {
    alert('Please enter a password or access code');
    return;
  }
  
  // Check for Admin password
  if(input === 'ha!ford') {
    isAdmin = true;
    isPaceLead = true;
    closeFestivalAdminModal();
    showPage('admin');
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    renderAdminEventsList();
    return;
  }
  
  // Check for PACE password
  if(input === 'pace2026') {
    isPaceLead = true;
    closeFestivalAdminModal();
    showPage('paceplanning');
    document.getElementById('pacePlanningLogin').style.display = 'none';
    document.getElementById('pacePlanningPanel').style.display = 'block';
    renderPlanningEvents();
    return;
  }
  
  // Check if it's a PACE Lead access code
  const code = input.toUpperCase();
  const userEvents = events.filter(e => e.accessCode && e.accessCode.toUpperCase() === code);
  
  if(userEvents.length > 0) {
    currentPaceLeadCode = code;
    closeFestivalAdminModal();
    showPage('paceleadportal');
    document.getElementById('paceLeadLogin').style.display = 'none';
    document.getElementById('paceLeadPanel').style.display = 'block';
    document.getElementById('paceLeadInfo').style.display = 'block';
    document.getElementById('paceLeadCodeDisplay').textContent = code;
    renderPaceLeadEvents();
    return;
  }
  
  // No match found
  alert('Invalid password or access code. Please try again.');
}

// Wrapper function for nav button
function openFestivalAdmin() {
  openFestivalAdminModal();
}

/* ============================================ */
/* PACE PLANNING LOGIN FUNCTIONS */
/* ============================================ */
function pacePlanningLogin() {
  const password = document.getElementById('pacePlanningPassword').value;
  if(password === 'pace2026') {
    isPaceLead = true;
    document.getElementById('pacePlanningLogin').style.display = 'none';
    document.getElementById('pacePlanningPanel').style.display = 'block';
    renderPlanningEvents();
  } else if(password === 'ha!ford') {
    isAdmin = true;
    isPaceLead = true;
    document.getElementById('pacePlanningLogin').style.display = 'none';
    document.getElementById('pacePlanningPanel').style.display = 'block';
    renderPlanningEvents();
  } else {
    alert('Incorrect password');
  }
}

let filteredPlanningEvents = null;

function getPlanningEvents() {
  // Return all events - calendar status filtered via filterCalendar dropdown
  return events;
}

function applyPlanningFilters() {
  const searchTerm = document.getElementById('searchPlanning').value.toLowerCase();
  const weekFilter = document.getElementById('filterWeek').value;
  const dayFilter = document.getElementById('filterDay').value;
  const timeFilter = document.getElementById('filterTime').value;
  const paceLeadFilter = document.getElementById('filterPaceLead').value;
  const sortBy = document.getElementById('sortPlanning').value;
  
  filteredPlanningEvents = getPlanningEvents().filter(e => {
    let matches = true;
    
    // Search filter (Event ID or Title)
    if(searchTerm) {
      const matchesSearch = 
        (e.uniqueId && e.uniqueId.toLowerCase().startsWith(searchTerm)) ||
        (e.title && e.title.toLowerCase().includes(searchTerm));
      if(!matchesSearch) {
        matches = false;
      }
    }
    
    // Week filter
    if(weekFilter && e.roughWeek && !e.roughWeek.includes(weekFilter)) {
      matches = false;
    }
    
    // Day filter
    if(dayFilter && e.roughDay && !e.roughDay.includes(dayFilter)) {
      matches = false;
    }
    
    // Time filter
    if(timeFilter && e.roughTime && !e.roughTime.includes(timeFilter)) {
      matches = false;
    }
    
    // PACE Lead filter
    if(paceLeadFilter && (!e.paceLead || e.paceLead !== paceLeadFilter)) {
      matches = false;
    }
    
    // Calendar filter
    const calendarFilter = document.getElementById('filterCalendar').value;
    const isOnCalendar = e.date && e.date !== '';
    if(calendarFilter === 'oncalendar' && !isOnCalendar) matches = false;
    if(calendarFilter === 'notcalendar' && isOnCalendar) matches = false;
    
    return matches;
  });
  
  // Apply sorting
  filteredPlanningEvents.sort((a, b) => {
    if(sortBy === 'paceLead') {
      const aLead = (a.paceLead || '').toLowerCase();
      const bLead = (b.paceLead || '').toLowerCase();
      if(aLead !== bLead) return aLead.localeCompare(bLead);
      return a.title.localeCompare(b.title); // then by title within same lead
    }
    return a.title.localeCompare(b.title); // default: title A-Z
  });
  
  renderPlanningEvents();
}

function clearPlanningFilters() {
  document.getElementById('searchPlanning').value = '';
  document.getElementById('filterWeek').value = '';
  document.getElementById('filterDay').value = '';
  document.getElementById('filterTime').value = '';
  document.getElementById('filterPaceLead').value = '';
  document.getElementById('filterCalendar').value = 'all';
  document.getElementById('sortPlanning').value = 'title';
  applyPlanningFilters();
}

/* ============================================ */
/* DATE-STAMPED PLANNING NOTES FUNCTIONS */
/* ============================================ */

// Convert legacy string notes to array format
function migrateNotes(planningNotes) {
  if(!planningNotes) return [];
  if(Array.isArray(planningNotes)) return planningNotes;
  // Legacy: plain string - wrap as single note with no date
  return [{ text: planningNotes, date: null }];
}

function addPlanningNote() {
  const noteInput = document.getElementById('eventNewNote');
  const text = noteInput.value.trim();
  if(!text) return;
  
  // Create new note with timestamp
  const newNote = {
    text: text,
    date: new Date().toISOString()
  };
  
  // If editing existing event
  if(editingEventId !== null) {
    const idx = events.findIndex(ev => ev.id === editingEventId);
    if(idx === -1) return;
    
    // Ensure planningNotes is always a proper array
    if(!events[idx].planningNotes || !Array.isArray(events[idx].planningNotes)) {
      events[idx].planningNotes = migrateNotes(events[idx].planningNotes);
    }
    
    // Add new note (create new array to avoid reference issues)
    events[idx].planningNotes = [newNote, ...events[idx].planningNotes];
    
    noteInput.value = '';
    saveEvents();
    renderPlanningNotesList(events[idx].planningNotes);
    
    // Log the note addition
    addChangeLogEntry('note', 'Note added to: ' + events[idx].title, {
      noteText: text
    }, events[idx]);
    
    // Update the background card if visible
    updateCardNotesDisplay(editingEventId);
  } else {
    // Creating new event - store in temporary array
    tempEventNotes = [newNote, ...tempEventNotes];
    noteInput.value = '';
    renderPlanningNotesList(tempEventNotes);
  }
}

function deleteNote(noteIndex) {
  // If editing existing event
  if(editingEventId !== null) {
    const idx = events.findIndex(ev => ev.id === editingEventId);
    if(idx === -1) return;
    
    if(!events[idx].planningNotes || !Array.isArray(events[idx].planningNotes)) {
      events[idx].planningNotes = migrateNotes(events[idx].planningNotes);
    }
    
    // Create new array instead of modifying in place
    events[idx].planningNotes = events[idx].planningNotes.filter((note, i) => i !== noteIndex);
    saveEvents();
    renderPlanningNotesList(events[idx].planningNotes);
    
    // Update the background card if visible
    updateCardNotesDisplay(editingEventId);
  } else {
    // Creating new event - delete from temporary array
    tempEventNotes = tempEventNotes.filter((note, i) => i !== noteIndex);
    renderPlanningNotesList(tempEventNotes);
  }
}

function updateCardNotesDisplay(eventId) {
  // Find the card in the background and update its notes section
  // This prevents needing a full page refresh to see note changes
  const cards = document.querySelectorAll('.admin-event-item, .event-card');
  cards.forEach(card => {
    // Check if this card is for the event being edited
    const editBtn = card.querySelector('[onclick*="editEvent(' + eventId + ')"], [onclick*="editPaceLeadEvent(' + eventId + ')"]');
    const viewBtn = card.querySelector('[onclick*="openPlanningEventView"]');
    
    if(editBtn || viewBtn) {
      // Found the card - rebuild just the notes section
      const event = events.find(e => e.id === eventId);
      if(!event) return;
      
      const notes = migrateNotes(event.planningNotes || []);
      
      // Find the notes container in this card
      let notesDiv = card.querySelector('[style*="background: #fff3cd"]');
      
      if(notes.length === 0) {
        // Remove notes section if no notes
        if(notesDiv) notesDiv.remove();
      } else {
        // Update or create notes section
        let notesHTML = '<div onclick="event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
        
        // Check which view we're in to determine the onclick handler
        if(editBtn && editBtn.getAttribute('onclick').includes('editEvent')) {
          notesHTML = '<div onclick="editEvent(' + eventId + ', true); event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
        } else if(editBtn && editBtn.getAttribute('onclick').includes('editPaceLeadEvent')) {
          notesHTML = '<div onclick="editPaceLeadEvent(' + eventId + ', true); event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
        } else if(viewBtn) {
          notesHTML = '<div onclick="openPlanningEventView(planningEventById(' + eventId + '), true); event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
        }
        
        notesHTML += '<div style="padding: 10px 15px 5px 15px;"><strong style="color: #856404;">ğŸ“ Planning Notes</strong>' + (notes.length > 1 ? ' <span style="color: #999; font-size: 0.85em;">(' + notes.length + ' notes)</span>' : '') + '</div>';
        notesHTML += '<div style="max-height: 150px; overflow-y: auto; padding: 0 15px 12px 15px;">';
        notes.forEach(function(note, i) {
          const nDateStr = note.date ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'No date';
          notesHTML += '<div style="padding: 8px 0; ' + (i < notes.length - 1 ? 'border-bottom: 1px dashed #ddd;' : '') + '">';
          notesHTML += '<span style="font-size: 0.8em; color: #856404; font-weight: bold;">' + nDateStr + '</span>';
          notesHTML += '<p style="margin: 4px 0 0 0; white-space: pre-wrap; line-height: 1.4;">' + note.text + '</p>';
          notesHTML += '</div>';
        });
        notesHTML += '</div></div>';
        
        if(notesDiv) {
          // Replace existing notes section
          notesDiv.outerHTML = notesHTML;
        } else {
          // Add notes section to card
          const infoDiv = card.querySelector('.admin-event-info');
          if(infoDiv) {
            infoDiv.insertAdjacentHTML('beforeend', notesHTML);
          }
        }
      }
    }
  });
}

function renderPlanningNotesList(notes) {
  const container = document.getElementById('planningNotesList');
  const migratedNotes = migrateNotes(notes);
  
  if(migratedNotes.length === 0) {
    container.innerHTML = '<p style="padding: 15px; color: #999; font-style: italic; text-align: center;">No notes yet</p>';
    return;
  }
  
  container.innerHTML = migratedNotes.map((note, i) => {
    const dateStr = note.date 
      ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })
      : 'No date';
    return `
      <div style="padding: 12px 15px; border-bottom: 1px solid #eee; ${i === 0 ? 'background: #fffdf0;' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="font-size: 0.8em; color: #856404; font-weight: bold;">ğŸ“ ${dateStr}</span>
          <button onclick="deleteNote(${i})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.1em; padding: 0 5px;" title="Delete note">âœ•</button>
        </div>
        <p style="margin: 0; white-space: pre-wrap; line-height: 1.4;">${note.text}</p>
      </div>`;
  }).join('');
}

// Print Planning Report
function printPlanningReport() {
  const eventsToShow = (filteredPlanningEvents && filteredPlanningEvents.length > 0) ? filteredPlanningEvents : getPlanningEvents();
  
  if(eventsToShow.length === 0) {
    alert('No events to print');
    return;
  }
  
  // Sort by rough week and date
  const sorted = [...eventsToShow].sort((a, b) => {
    if(a.roughWeek && b.roughWeek) {
      return a.roughWeek.localeCompare(b.roughWeek);
    }
    if(a.date && b.date) {
      return new Date(a.date) - new Date(b.date);
    }
    return 0;
  });
  
  // Create print window - larger size
  const printWindow = window.open('', '', 'width=1200,height=800');
  
  let html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>MEF 2026 Planning Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        h1 { text-align: center; color: #2B7BBD; border-bottom: 3px solid #8DC63F; padding-bottom: 10px; }
        .date { text-align: center; color: #666; margin-bottom: 30px; }
        .print-controls { text-align: center; margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px; }
        .print-btn { background: #28a745; color: white; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 0 10px; }
        .print-btn:hover { background: #218838; }
        .close-btn { background: #6c757d; color: white; border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 0 10px; }
        .close-btn:hover { background: #5a6268; }
        .event { page-break-inside: avoid; margin-bottom: 30px; border-left: 4px solid #FFA500; padding-left: 15px; }
        .event-title { color: #2B7BBD; font-size: 1.3em; font-weight: bold; margin-bottom: 5px; }
        .event-meta { color: #666; margin: 5px 0; }
        .pace-lead { font-weight: bold; color: #000; }
        .notes-section { background: #fff8dc; padding: 15px; margin-top: 10px; border-left: 4px solid #ffc107; }
        .notes-title { font-weight: bold; color: #856404; margin-bottom: 8px; }
        .notes-text { white-space: pre-wrap; }
        hr { border: none; border-top: 1px dashed #ccc; margin: 20px 0; }
        @media print {
          body { margin: 20px; }
          .event { page-break-inside: avoid; }
          .print-controls { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="print-controls">
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Print Report</button>
        <button class="close-btn" onclick="window.close()">âœ– Close Window</button>
      </div>
      <h1>MANNINGTREE EARTH FESTIVAL 2026</h1>
      <h2 style="text-align: center; color: #8DC63F;">Planning Meeting Report</h2>
      <p class="date">Generated: ${new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
      <p style="text-align: center; margin-bottom: 30px;"><strong>Total Events in Planning: ${sorted.length}</strong></p>
  `;
  
  sorted.forEach((event, index) => {
    let timing = [];
    if(event.roughWeek) timing.push(event.roughWeek);
    if(event.roughDay) timing.push(event.roughDay);
    if(event.roughTime) timing.push(event.roughTime);
    if(event.date) {
      const dateObj = new Date(event.date + 'T12:00:00');
      timing.push(dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' }));
    }
    if(event.time) {
      const printSlots = getAllTimeSlots(event);
      if(printSlots.length > 1) {
        timing.push(printSlots.map(s => formatSlotTime(s)).join(', '));
      } else {
        timing.push(event.time);
      }
    }
    const printRecStr = formatRecurrence(event);
    if(printRecStr) timing.push('ğŸ” ' + printRecStr);
    
    html += `
      <div class="event">
        <div class="event-title">${event.title}</div>
        ${event.uniqueId ? `<div class="event-meta">Event ID: ${event.uniqueId}</div>` : ''}
        ${event.paceLead ? `<div class="event-meta"><span class="pace-lead">PACE Lead: ${event.paceLead}</span></div>` : ''}
        ${event.organiser ? `<div class="event-meta">Organiser: ${event.organiser}</div>` : ''}
        ${timing.length > 0 ? `<div class="event-meta">ğŸ“… ${timing.join(' â€¢ ')}</div>` : '<div class="event-meta">ğŸ“… Dates TBC</div>'}
        ${event.location ? `<div class="event-meta">ğŸ“ ${event.location}${event.venue ? ' - ' + event.venue : ''}</div>` : ''}
        ${event.summary ? `<p style="margin-top: 10px;">${event.summary}</p>` : ''}
        <div class="notes-section">
          <div class="notes-title">ğŸ“ Planning Notes:</div>
          <div class="notes-text">${(() => {
            const notes = migrateNotes(event.planningNotes);
            if(notes.length === 0) return '<em style="color: #999;">No planning notes yet</em>';
            return notes.map(n => {
              const dateStr = n.date ? ' <span style="color: #999; font-size: 0.85em;">[' + new Date(n.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + ']</span>' : '';
              return '<div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #ddd;"><strong>ğŸ“' + dateStr + '</strong><br>' + n.text + '</div>';
            }).join('');
          })()}</div>
        </div>
      </div>
      ${index < sorted.length - 1 ? '<hr>' : ''}
    `;
  });
  
  html += `
    </body>
    </html>
  `;
  
  printWindow.document.write(html);
  printWindow.document.close();
  
  // Wait for content to load, then focus the window
  // User can review before printing and close manually
  setTimeout(() => {
    printWindow.focus();
  }, 100);
}

async function downloadWordReport() {
  const eventsToShow = (filteredPlanningEvents && filteredPlanningEvents.length > 0) ? filteredPlanningEvents : getPlanningEvents();
  
  if(eventsToShow.length === 0) {
    alert('No events to export');
    return;
  }
  
  // Show loading message
  showToast('â³ Generating Word document...');
  
  // Sort by PACE Lead name first, then by title
  const sorted = [...eventsToShow].sort((a, b) => {
    const aLead = (a.paceLead || 'ZZZ').toLowerCase(); // Put events without PACE Lead at end
    const bLead = (b.paceLead || 'ZZZ').toLowerCase();
    if(aLead !== bLead) {
      return aLead.localeCompare(bLead);
    }
    // Within same PACE Lead, sort by title
    return (a.title || '').localeCompare(b.title || '');
  });
  
  try {
    // Generate HTML that Word can open and convert
    let html = `<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset='utf-8'>
<title>MEF 2026 Planning Report</title>
<style>
@page {
  size: A4;
  margin: 2.54cm;
}
body {
  font-family: Arial, sans-serif;
  font-size: 11pt;
  line-height: 1.4;
  margin: 0;
  padding: 0;
  color: #000000;
}
h1 {
  text-align: center;
  color: #000000;
  font-size: 16pt;
  font-weight: bold;
  margin-bottom: 8pt;
  border-bottom: 2pt solid #000000;
  padding-bottom: 8pt;
}
h2 {
  text-align: center;
  color: #000000;
  font-size: 14pt;
  font-weight: bold;
  margin-bottom: 8pt;
}
.date {
  text-align: center;
  color: #000000;
  font-size: 10pt;
  margin-bottom: 15pt;
}
.event-count {
  text-align: center;
  font-weight: bold;
  font-size: 11pt;
  margin-bottom: 20pt;
}
.event {
  page-break-inside: avoid;
  margin-bottom: 15pt;
  border-left: 3pt solid #000000;
  padding-left: 10pt;
}
.event-title {
  color: #000000;
  font-size: 12pt;
  font-weight: bold;
  margin-bottom: 3pt;
}
.event-meta {
  color: #000000;
  margin: 0;
  font-size: 10pt;
  line-height: 1.3;
}
.note-text {
  background-color: #F5F5F5;
  padding: 8pt;
  margin-top: 5pt;
  border-left: 2pt solid #666666;
  font-size: 10pt;
  font-style: italic;
  white-space: pre-wrap;
}
hr {
  border: none;
  border-top: 1pt solid #CCCCCC;
  margin: 10pt 0;
}
</style>
</head>
<body>
`;
    
    // Title
    html += '<h1>MANNINGTREE EARTH FESTIVAL 2026</h1>\n';
    html += '<h2>Planning Meeting Report</h2>\n';
    
    // Date
    const today = new Date().toLocaleDateString('en-GB', { 
      weekday: 'long', 
      day: 'numeric', 
      month: 'long', 
      year: 'numeric' 
    });
    html += '<p class="date">Generated: ' + today + '</p>\n';
    
    // Event count
    html += '<p class="event-count">Total Events in Planning: ' + sorted.length + '</p>\n';
    
    // Process each event
    sorted.forEach((event, index) => {
      html += '<div class="event">\n';
      
      // Event title (no ID)
      html += '<div class="event-title">' + (event.title || 'Untitled Event') + '</div>\n';
      
      // PACE Lead, Organiser, and Timing on one line
      const infoLine = [];
      
      if(event.paceLead) {
        infoLine.push('<strong>PACE Lead:</strong> ' + event.paceLead);
      }
      
      if(event.organiser) {
        infoLine.push('<strong>Organiser:</strong> ' + event.organiser);
      }
      
      // Timing information
      const timing = [];
      if(event.roughWeek) timing.push(event.roughWeek);
      if(event.roughDay) timing.push(event.roughDay);
      if(event.roughTime) timing.push(event.roughTime);
      if(event.date) {
        const dateObj = new Date(event.date + 'T12:00:00');
        timing.push(dateObj.toLocaleDateString('en-GB', { 
          day: 'numeric', 
          month: 'short'
        }));
      }
      if(event.time) timing.push(event.time);
      
      if(timing.length > 0) {
        infoLine.push('<strong>When:</strong> ' + timing.join(', '));
      }
      
      if(infoLine.length > 0) {
        html += '<div class="event-meta">' + infoLine.join(' | ') + '</div>\n';
      }
      
      // Location (separate line, more compact)
      if(event.location || event.venue) {
        let locationText = event.location || '';
        if(event.venue) {
          if(locationText) locationText += ' - ';
          locationText += event.venue;
        }
        html += '<div class="event-meta"><strong>Where:</strong> ' + locationText + '</div>\n';
      }
      
      // Summary (if exists)
      if(event.summary) {
        html += '<div class="event-meta" style="margin-top: 3pt;">' + event.summary + '</div>\n';
      }
      
      // Latest note only
      const notes = migrateNotes(event.planningNotes);
      if(notes.length > 0) {
        // Get the most recent note (first one since they're sorted newest first)
        const latestNote = notes[0];
        const dateStr = latestNote.date 
          ? new Date(latestNote.date).toLocaleDateString('en-GB', { 
              day: 'numeric', 
              month: 'short',
              hour: '2-digit', 
              minute: '2-digit' 
            })
          : '';
        
        html += '<div class="note-text">';
        if(dateStr) {
          html += '<strong>[' + dateStr + ']</strong> ';
        }
        html += latestNote.text;
        html += '</div>\n';
      }
      
      html += '</div>\n'; // close event
      
      // Separator line between events (except last one)
      if(index < sorted.length - 1) {
        html += '<hr>\n';
      }
    });
    
    html += '</body></html>';
    
    // Create blob and download
    const blob = new Blob([html], { type: 'application/msword' });
    const filename = 'MEF_2026_Planning_Report_' + new Date().toISOString().split('T')[0] + '.doc';
    
    // Create download link
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
    
    showToast('âœ“ Word document downloaded! Open it in Word to edit and save as .docx');
    
  } catch(error) {
    console.error('Error generating Word document:', error);
    console.error('Error stack:', error.stack);
    alert('Error generating Word document: ' + error.message + '\n\nPlease try the Print Report option instead.');
  }
}

function populatePaceLeadFilter() {
  const select = document.getElementById('filterPaceLead');
  const currentVal = select.value;
  const leads = [...new Set(getPlanningEvents().map(e => e.paceLead).filter(Boolean))].sort();
  select.innerHTML = '<option value="">All PACE Leads</option>';
  leads.forEach(lead => {
    select.innerHTML += '<option value="' + lead + '">' + lead + '</option>';
  });
  select.value = currentVal; // preserve selection if still valid
}

function planningEventById(id) {
  return events.find(e => e.id === id);
}

function renderPlanningEvents() {
  populatePaceLeadFilter();
  
  // If filters haven't been applied yet, apply them now with default/empty filters
  if(filteredPlanningEvents === null) {
    applyPlanningFilters();
    return; // applyPlanningFilters calls renderPlanningEvents again
  }
  
  const container = document.getElementById('planningEventsList');
  const eventsToShow = filteredPlanningEvents;
  
  // Update event counter
  const counterEl = document.getElementById('planningEventCount');
  if(counterEl) {
    const totalEvents = getPlanningEvents().length;
    if(eventsToShow.length === totalEvents) {
      counterEl.textContent = eventsToShow.length;
    } else {
      counterEl.textContent = eventsToShow.length + ' of ' + totalEvents;
    }
  }
  
  container.innerHTML = '';
  
  if(eventsToShow.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No planning events found.</p>';
    return;
  }
  
  eventsToShow.forEach(e => {
    let div = document.createElement('div');
	div.style.cursor = 'pointer';
div.onclick = () => openPlanningEventView(e, false); // false = don't scroll to notes
    div.className = 'event-card';
    
    const isOnCalendar = e.date && e.date !== '';
    const borderColour = isOnCalendar ? '#4CAF50' : '#FFA500';
    const badgeBg = isOnCalendar ? '#4CAF50' : '#FFA500';
    const badgeText = isOnCalendar ? 'ON CALENDAR' : 'IN PLANNING';
    div.style.borderColor = borderColour;
    
    let roughInfo = [];
    if(isOnCalendar) {
      roughInfo.push(`ğŸ“… ${formatDate(e.date)}`);
    } else {
      if(e.roughWeek) roughInfo.push(`ğŸ“… ${e.roughWeek}`);
      if(e.roughDay) roughInfo.push(`ğŸ“† ${e.roughDay}`);
      if(e.roughTime) roughInfo.push(`ğŸ• ${e.roughTime}`);
    }
    const planRecStr = formatRecurrence(e);
    if(planRecStr) roughInfo.push('ğŸ” ' + planRecStr);
    
    let html = `
    <div style="display: inline-block; background: ${badgeBg}; color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px;">
      ${badgeText}
    </div>
    <h3 class="event-title" style="color: ${borderColour};">${e.title}</h3>
    <div class="event-meta" style="margin-bottom: 10px; color: #666;">
      ${roughInfo.length > 0 ? roughInfo.join(' â€¢ ') : 'Dates TBC'}
    </div>`;
    
    if(e.summary) {
      html += `<p style="margin: 10px 0; line-height: 1.4;">${e.summary}</p>`;
    }
    
    if(e.paceLead) {
      html += `<p style="margin-top: 10px; color: #666;"><strong>PACE Lead:</strong> ${e.paceLead}</p>`;
    }
    
    if(e.organiser) {
      html += `<p style="margin-top: 10px; color: #666;"><strong>Organiser:</strong> ${e.organiser}</p>`;
    }
    
    // Planning Notes - scrollable box
    const cardNotes = migrateNotes(e.planningNotes);
    if(cardNotes.length > 0) {
      html += `<div onclick="event.stopPropagation(); openPlanningEventView(planningEventById('${e.id}'), true);" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">`;
      html += `<div style="padding: 10px 15px 5px 15px;"><strong style="color: #856404;">ğŸ“ Planning Notes</strong>${cardNotes.length > 1 ? ' <span style="color: #999; font-size: 0.85em;">(' + cardNotes.length + ' notes)</span>' : ''}</div>`;
      html += `<div style="max-height: 150px; overflow-y: auto; padding: 0 15px 12px 15px;">`;
      cardNotes.forEach((note, i) => {
        const nDateStr = note.date ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'No date';
        html += `<div style="padding: 8px 0; ${i < cardNotes.length - 1 ? 'border-bottom: 1px dashed #ddd;' : ''}">`;
        html += `<span style="font-size: 0.8em; color: #856404; font-weight: bold;">${nDateStr}</span>`;
        html += `<p style="margin: 4px 0 0 0; white-space: pre-wrap; line-height: 1.4;">${note.text}</p>`;
        html += `</div>`;
      });
      html += `</div></div>`;
    } else {
      html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #dee2e6; border-radius: 5px;">`;
      html += `<em style="color: #6c757d; font-size: 0.9em;">ğŸ“ No planning notes yet.</em>`;
      html += `</div>`;
    }
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}
function openPlanningEventView(event, scrollToNotes = false) {
  // Open the form in read-only mode
  openEventForm(event);
  
  // Immediately reset scroll (openEventForm also does this but doesn't hurt)
  const modalContent = document.querySelector('#eventModal .modal-content');
  if(modalContent) modalContent.scrollTop = 0;
  
// Disable all input fields
  document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
    if(field.id !== 'eventUniqueId') { // Event ID already disabled
      field.disabled = true;
      if(field.value) {
        field.style.background = 'white';
        field.style.color = 'black';
      } else {
        field.style.background = '#f5f5f5';
      }
      field.style.cursor = 'not-allowed';
    }
  });
  
  // SECURITY FIX: Hide Access Code field - it should NEVER be visible to others
  const accessCodeField = document.getElementById('eventAccessCode');
  if(accessCodeField) {
    accessCodeField.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; // Mask the value
    accessCodeField.type = 'password'; // Hide it further
    accessCodeField.disabled = true;
  }
  
  // Hide the normal Save/Cancel buttons
  document.querySelector('.form-actions').style.display = 'none';
  
  // Hide Add Note button - read only until password entered
  const addNoteBtn = document.querySelector('#eventNewNote + button');
  if(addNoteBtn) addNoteBtn.style.display = 'none';
  document.getElementById('eventNewNote').style.display = 'none';
  // Hide delete buttons on notes
  document.querySelectorAll('#planningNotesList button').forEach(btn => btn.style.display = 'none');
  
  // Remove any existing PACE buttons first
  let existingPaceButtons = document.getElementById('paceViewButtons');
  if(existingPaceButtons) existingPaceButtons.remove();
  
  // Add PACE view buttons (Close + Edit with password)
  let paceButtons = document.createElement('div');
  paceButtons.id = 'paceViewButtons';
  paceButtons.className = 'form-actions';
  paceButtons.innerHTML = `
    <button type="button" class="btn btn-secondary" onclick="closePaceEventView()">Close</button>
    <button type="button" class="btn" onclick="requestEditAccess()">ğŸ”’ Edit This Event</button>
  `;
  document.getElementById('eventForm').appendChild(paceButtons);
  
  // Change jump button text to "Jump to Close" for read-only view
  const jumpBtn = document.getElementById('jumpToSave');
  if(jumpBtn) {
    jumpBtn.textContent = 'â†“ Jump to Close';
  }
  
  // Scroll to Planning Notes section ONLY if scrollToNotes is true
  if(scrollToNotes) {
    setTimeout(function() {
      const modalContent = document.querySelector('#eventModal .modal-content');
      const planningNotesField = document.getElementById('planningNotesList');
      if(modalContent && planningNotesField) {
        const modalRect = modalContent.getBoundingClientRect();
        const notesRect = planningNotesField.getBoundingClientRect();
        modalContent.scrollTop += (notesRect.top - modalRect.top) - 80;
      }
    }, 350);
  }
}

function closePaceEventView() {
  closeEventForm();
  // Re-enable all fields for next time
  document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
    if(field.id !== 'eventUniqueId') {
      field.disabled = false;
      field.style.background = '';
      field.style.cursor = '';
    }
  });
  // Restore notes controls for next time
  restoreNoteControls();
  // Restore Access Code field to normal text input
  const accessCodeField = document.getElementById('eventAccessCode');
  if(accessCodeField) {
    accessCodeField.type = 'text';
  }
  // Restore jump button text
  const jumpBtn = document.getElementById('jumpToSave');
  if(jumpBtn) {
    jumpBtn.textContent = 'â†“ Jump to Save';
  }
  // Restore original buttons
  document.querySelector('.form-actions').style.display = 'flex';
  let paceButtons = document.getElementById('paceViewButtons');
  if(paceButtons) paceButtons.remove();
}

function restoreNoteControls() {
  // Show the Add Note input and button
  const newNoteInput = document.getElementById('eventNewNote');
  if(newNoteInput) newNoteInput.style.display = '';
  const addNoteBtn = newNoteInput ? newNoteInput.nextElementSibling : null;
  if(addNoteBtn) addNoteBtn.style.display = '';
  // Show delete buttons on notes
  document.querySelectorAll('#planningNotesList button').forEach(btn => btn.style.display = '');
}

function requestEditAccess() {
  const password = prompt('Enter Admin password or your PACE Lead code (e.g., HH1234):');
  
  if(!password) return;
  
  const upperPassword = password.trim().toUpperCase();
  
  // Check if it's admin password
  if(upperPassword === 'HA!FORD') {
    // Admin can edit everything
    document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
      if(field.id !== 'eventUniqueId') {
        field.disabled = false;
        field.style.background = '';
        field.style.cursor = '';
      }
    });
    // Restore Access Code field to normal and reload the actual value
    const accessCodeField = document.getElementById('eventAccessCode');
    if(accessCodeField && editingEventId !== null) {
      const event = events.find(e => e.id === editingEventId);
      if(event) {
        accessCodeField.type = 'text';
        accessCodeField.value = event.accessCode || '';
      }
    }
    // Switch to normal buttons
    document.getElementById('paceViewButtons').remove();
    document.querySelector('.form-actions').style.display = 'flex';
    
    // Restore notes controls
    restoreNoteControls();
    
    // Update jump button text back to "Jump to Save"
    const jumpBtn = document.getElementById('jumpToSave');
    if(jumpBtn) jumpBtn.textContent = 'â†“ Jump to Save';
    
    alert('Admin edit mode enabled');
  } else {
    // Check if it's a PACE Lead code that matches this event
    if(editingEventId !== null) {
      const event = events.find(e => e.id === editingEventId);
      if(event && event.accessCode && event.accessCode.toUpperCase() === upperPassword) {
        // PACE Lead code matches - allow editing
        document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
          if(field.id !== 'eventUniqueId') {
            field.disabled = false;
            field.style.background = '';
            field.style.cursor = '';
          }
        });
        // Keep Access Code masked for PACE Leads (they shouldn't see it)
        const accessCodeField = document.getElementById('eventAccessCode');
        if(accessCodeField) {
          accessCodeField.value = event.accessCode || '';
          accessCodeField.disabled = true;
          accessCodeField.style.background = '#f0f0f0';
        }
        // Switch to normal buttons
        document.getElementById('paceViewButtons').remove();
        document.querySelector('.form-actions').style.display = 'flex';
        
        // Restore notes controls
        restoreNoteControls();
        
        // Update jump button text back to "Jump to Save"
        const jumpBtn = document.getElementById('jumpToSave');
        if(jumpBtn) jumpBtn.textContent = 'â†“ Jump to Save';
        
        alert('Edit mode enabled for your event');
      } else {
        alert('Incorrect password or this is not your event');
      }
    }
  }
}

/* ============================================ */
/* PACE LEAD PORTAL FUNCTIONS */
/* ============================================ */
function paceLeadLogin() {
  const code = document.getElementById('paceLeadCode').value.trim().toUpperCase();
  
  if(!code) {
    alert('Please enter your access code');
    return;
  }
  
  // Check if any events exist with this code
  const userEvents = events.filter(e => e.accessCode && e.accessCode.toUpperCase() === code);
  
  if(userEvents.length === 0) {
    alert('No events found with this access code. Please check your code and try again.');
    return;
  }
  
  // Login successful
  currentPaceLeadCode = code;
  document.getElementById('paceLeadLogin').style.display = 'none';
  document.getElementById('paceLeadPanel').style.display = 'block';
  document.getElementById('paceLeadInfo').style.display = 'block';
  document.getElementById('paceLeadCodeDisplay').textContent = code;
  renderPaceLeadEvents();
}

function paceLeadLogout() {
  currentPaceLeadCode = null;
  document.getElementById('paceLeadLogin').style.display = 'block';
  document.getElementById('paceLeadPanel').style.display = 'none';
  document.getElementById('paceLeadInfo').style.display = 'none';
  document.getElementById('paceLeadCode').value = '';
}

function renderPaceLeadEvents() {
  const container = document.getElementById('paceLeadEventsList');
  container.innerHTML = '';
  
  if(!currentPaceLeadCode) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Please log in to view your events.</p>';
    return;
  }
  
  const userEvents = events.filter(e => e.accessCode && e.accessCode.toUpperCase() === currentPaceLeadCode.toUpperCase());
  
  document.getElementById('paceLeadEventCount').textContent = userEvents.length;
  
  if(userEvents.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No events found. Click "Add New Event" to create one.</p>';
    return;
  }
  
  const sortedEvents = [...userEvents].sort((a,b) => {
    return a.title.localeCompare(b.title);
  });
  
  sortedEvents.forEach((e)=>{
    let div = document.createElement('div');
    div.className='admin-event-item';
    let metaInfo = [];
    if(e.type) metaInfo.push(e.type);
    if(e.date) metaInfo.push(formatDate(e.date));
    if(e.time) {
      const allSlots = getAllTimeSlots(e);
      if(allSlots.length > 1) {
        metaInfo.push('â° ' + allSlots.length + ' slots');
      } else {
        metaInfo.push(e.time);
      }
    }
    
    // Show rough dates if no actual date
    if(!e.date && e.roughWeek) metaInfo.push('ğŸ“… ' + e.roughWeek);
    if(!e.date && e.roughDay) metaInfo.push('ğŸ“† ' + e.roughDay);
    if(!e.time && e.roughTime) metaInfo.push('ğŸ• ' + e.roughTime);
    const myRecStr = formatRecurrence(e);
    if(myRecStr) metaInfo.push('ğŸ” ' + myRecStr);
    
    let html = '<div class="admin-event-info">';
    html += '<h3 class="admin-event-title">' + e.title + '</h3>';
    html += '<p class="admin-event-meta"><strong>Event ID:</strong> ' + (e.uniqueId || 'N/A') + '</p>';
    if(metaInfo.length>0) html += '<p class="admin-event-meta">'+metaInfo.join(' â€¢ ')+'</p>';
    if(e.summary) html += '<p class="admin-event-meta" style="font-style: italic; color: #555;">'+e.summary+'</p>';
    if(e.location) html += '<p class="admin-event-meta">Location: '+e.location+'</p>';
    if(e.venue) html += '<p class="admin-event-meta">Venue: '+e.venue+'</p>';
    if(e.organiser) html += '<p class="admin-event-meta">Organiser: '+e.organiser+'</p>';
    
    // Planning Notes - scrollable box, clickable to open at notes section
    const myNotes = migrateNotes(e.planningNotes);
    if(myNotes.length > 0) {
      html += '<div onclick="editPaceLeadEvent(' + e.id + ', true); event.stopPropagation();" style="margin-top: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; overflow: hidden; cursor: pointer;">';
      html += '<div style="padding: 10px 15px 5px 15px;"><strong style="color: #856404;">ğŸ“ Planning Notes</strong>' + (myNotes.length > 1 ? ' <span style="color: #999; font-size: 0.85em;">(' + myNotes.length + ' notes)</span>' : '') + '</div>';
      html += '<div style="max-height: 150px; overflow-y: auto; padding: 0 15px 12px 15px;">';
      myNotes.forEach(function(note, i) {
        const nDateStr = note.date ? new Date(note.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'No date';
        html += '<div style="padding: 8px 0; ' + (i < myNotes.length - 1 ? 'border-bottom: 1px dashed #ddd;' : '') + '">';
        html += '<span style="font-size: 0.8em; color: #856404; font-weight: bold;">' + nDateStr + '</span>';
        html += '<p style="margin: 4px 0 0 0; white-space: pre-wrap; line-height: 1.4;">' + note.text + '</p>';
        html += '</div>';
      });
      html += '</div></div>';
    } else {
      html += '<div onclick="editPaceLeadEvent(' + e.id + ', true); event.stopPropagation();" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-left: 4px solid #dee2e6; border-radius: 5px; cursor: pointer;">';
      html += '<em style="color: #6c757d; font-size: 0.9em;">ğŸ“ No planning notes yet. Click here to open and add notes.</em>';
      html += '</div>';
    }
    
    html += '</div><div class="admin-event-actions">';
    html += '<button class="btn-edit" onclick="editPaceLeadEvent('+e.id+')">Edit</button>';
    html += '</div>';
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}

// NEW FUNCTION: Edit event from PACE Lead portal - ensures fields are editable
function editPaceLeadEvent(id, scrollToNotes = false) {
  const event = events.find(e=>e.id===id);
  if(event) {
    openEventForm(event);
    // Ensure all fields are enabled for editing
    document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
      if(field.id === 'eventUniqueId') {
        // Event ID: keep disabled for non-admins
        field.disabled = !isAdmin;
      } else {
        field.disabled = false;
        field.style.background = '';
        field.style.cursor = '';
      }
    });
    
    // Scroll to Planning Notes section if requested
    if(scrollToNotes) {
      setTimeout(() => {
        const modalContent = document.querySelector('#eventModal .modal-content');
        const planningNotesField = document.getElementById('planningNotesList');
        if(modalContent && planningNotesField) {
          const modalRect = modalContent.getBoundingClientRect();
          const notesRect = planningNotesField.getBoundingClientRect();
          modalContent.scrollTop += (notesRect.top - modalRect.top) - 80;
        }
      }, 100);
    }
  }
}

/* SECTION END: ADMIN FUNCTIONS */

/* ============================================ */
/* TIME SLOTS FUNCTIONS */
/* ============================================ */
let currentTimeSlots = []; // extra slots beyond the first (which lives in time/duration fields)

function showTimeSlotsSection() {
  const hasDate = document.getElementById('eventDate').value !== '';
  document.getElementById('timeSlotsSection').style.display = hasDate ? 'block' : 'none';
}

function renderTimeSlotsList() {
  const container = document.getElementById('timeSlotsList');
  container.innerHTML = '';
  currentTimeSlots.forEach((slot, i) => {
    const div = document.createElement('div');
    div.style.cssText = 'display: flex; gap: 10px; align-items: center; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 6px;';
    div.innerHTML = `
      <span style="font-weight: bold; color: #666; min-width: 30px;">${i + 2}.</span>
      <select class="slot-hour" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 60px;">${generateHourOptions(slot.time ? slot.time.split(':')[0] : '')}</select>
      <select class="slot-minute" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 60px;">${generateMinuteOptions(slot.time ? slot.time.split(':')[1] : '00')}</select>
      <span style="color: #666;">for</span>
      <select class="slot-dur-h" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 70px;">${generateDurHourOptions(slot.duration ? Math.floor(slot.duration / 60) : 0)}</select>
      <select class="slot-dur-m" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 80px;">${generateDurMinOptions(slot.duration ? slot.duration % 60 : 0)}</select>
      <button type="button" onclick="removeTimeSlot(${i})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 10px; cursor: pointer; margin-left: auto;">âœ•</button>
    `;
    container.appendChild(div);
  });
}

function generateHourOptions(selected) {
  let html = '<option value="">Hr</option>';
  for(let h = 0; h < 24; h++) {
    const val = String(h).padStart(2, '0');
    html += `<option value="${val}"${val === selected ? ' selected' : ''}>${val}</option>`;
  }
  return html;
}
function generateMinuteOptions(selected) {
  let html = '';
  ['00','15','30','45'].forEach(m => { html += `<option value="${m}"${m === selected ? ' selected' : ''}>${m}</option>`; });
  return html;
}
function generateDurHourOptions(selected) {
  let html = '';
  for(let h = 0; h <= 12; h++) { html += `<option value="${h}"${h === selected ? ' selected' : ''}>${h}h</option>`; }
  return html;
}
function generateDurMinOptions(selected) {
  let html = '';
  [0,15,30,45].forEach(m => { html += `<option value="${m}"${m === selected ? ' selected' : ''}>${m}m</option>`; });
  return html;
}

function addTimeSlot() {
  // Default new slot: duration after the last slot ends
  let defaultHour = 13;
  const firstDur = (parseInt(document.getElementById('eventDurationHours').value) * 60) + parseInt(document.getElementById('eventDurationMinutes').value) || 60;
  if(currentTimeSlots.length > 0) {
    const lastSlot = currentTimeSlots[currentTimeSlots.length - 1];
    const lastH = parseInt(lastSlot.time.split(':')[0]);
    const lastM = parseInt(lastSlot.time.split(':')[1]);
    const totalMins = lastH * 60 + lastM + (lastSlot.duration || firstDur);
    defaultHour = Math.floor(totalMins / 60);
  } else {
    const firstH = parseInt(document.getElementById('eventTimeHour').value || '13');
    const firstM = parseInt(document.getElementById('eventTimeMinute').value || '00');
    defaultHour = Math.floor((firstH * 60 + firstM + firstDur) / 60);
  }
  currentTimeSlots.push({ time: String(defaultHour).padStart(2,'0') + ':00', duration: firstDur });
  renderTimeSlotsList();
}

function removeTimeSlot(index) {
  currentTimeSlots.splice(index, 1);
  renderTimeSlotsList();
}

function readTimeSlotsFromForm() {
  // Read current state of all slot dropdowns back into currentTimeSlots
  const rows = document.querySelectorAll('#timeSlotsList > div');
  currentTimeSlots = [];
  rows.forEach(row => {
    const h = row.querySelector('.slot-hour').value;
    const m = row.querySelector('.slot-minute').value;
    const dh = parseInt(row.querySelector('.slot-dur-h').value);
    const dm = parseInt(row.querySelector('.slot-dur-m').value);
    if(h) currentTimeSlots.push({ time: h + ':' + m, duration: (dh * 60) + dm });
  });
  return currentTimeSlots;
}

function getAllTimeSlots(event) {
  // Given an event object, returns ALL slots as an array sorted by time
  // First slot is always time/duration, extras are in timeSlots[]
  const slots = [];
  if(event.time) slots.push({ time: event.time, duration: event.duration || 0 });
  if(event.timeSlots && event.timeSlots.length > 0) {
    event.timeSlots.forEach(s => slots.push(s));
  }
  slots.sort((a, b) => a.time.localeCompare(b.time));
  return slots;
}

function formatSlotTime(slot) {
  // "13:00 for 1h 30m"
  const h = Math.floor((slot.duration || 0) / 60);
  const m = (slot.duration || 0) % 60;
  let dur = '';
  if(h > 0) dur += h + 'h';
  if(m > 0) dur += (h > 0 ? ' ' : '') + m + 'm';
  return slot.time + (dur ? ' (' + dur + ')' : '');
}

/* ============================================ */
/* RECURRENCE FUNCTIONS */
/* ============================================ */

function showRecurrenceSection() {
  const hasDate = document.getElementById('eventDate').value !== '';
  document.getElementById('recurrenceSection').style.display = hasDate ? 'block' : 'none';
}

function updateRecurrenceUI() {
  const type = document.getElementById('recurrenceType').value;
  document.getElementById('recurrenceDaysRow').style.display = (type === 'weekly') ? 'block' : 'none';
  document.getElementById('recurrenceEndRow').style.display = (type !== 'none') ? 'flex' : 'none';
  // Auto-tick the start date's day of week if weekly and nothing ticked yet
  if(type === 'weekly') {
    const startDate = document.getElementById('eventDate').value;
    if(startDate) {
      const dow = new Date(startDate + 'T12:00:00').getDay(); // 0=Sun..6=Sat
      const cb = document.getElementById('recDay' + dow);
      if(cb) cb.checked = true;
    }
  }
}

function loadRecurrenceFields(event) {
  const rec = event.recurrence;
  if(!rec || rec.type === 'none') {
    document.getElementById('recurrenceType').value = 'none';
    document.getElementById('recurrenceDaysRow').style.display = 'none';
    document.getElementById('recurrenceEndRow').style.display = 'none';
    // Uncheck all days
    [0,1,2,3,4,5,6].forEach(d => { const cb = document.getElementById('recDay'+d); if(cb) cb.checked = false; });
    document.getElementById('recurrenceEndDate').value = '';
  } else {
    document.getElementById('recurrenceType').value = rec.type;
    document.getElementById('recurrenceDaysRow').style.display = (rec.type === 'weekly') ? 'block' : 'none';
    document.getElementById('recurrenceEndRow').style.display = 'flex';
    // Set day checkboxes
    [0,1,2,3,4,5,6].forEach(d => {
      const cb = document.getElementById('recDay'+d);
      if(cb) cb.checked = rec.days ? rec.days.includes(d) : false;
    });
    document.getElementById('recurrenceEndDate').value = rec.endDate || '';
  }
}

function readRecurrenceFromForm() {
  const type = document.getElementById('recurrenceType').value;
  if(type === 'none') return null;
  const days = [];
  [0,1,2,3,4,5,6].forEach(d => {
    if(document.getElementById('recDay'+d) && document.getElementById('recDay'+d).checked) days.push(d);
  });
  const endDate = document.getElementById('recurrenceEndDate').value;
  return { type: type, days: days, endDate: endDate };
}

function getEventDatesInRange(event, rangeStart, rangeEnd) {
  // Returns array of date strings (YYYY-MM-DD) that this event falls on within [rangeStart, rangeEnd]
  // rangeStart/rangeEnd are date strings
  if(!event.date) return [];
  const start = new Date(event.date + 'T12:00:00');
  const rStart = new Date(rangeStart + 'T12:00:00');
  const rEnd = new Date(rangeEnd + 'T12:00:00');
  
  if(!event.recurrence || event.recurrence.type === 'none') {
    // Non-recurring: just the single date if in range
    if(start >= rStart && start <= rEnd) return [event.date];
    return [];
  }
  
  const rec = event.recurrence;
  const endDate = rec.endDate ? new Date(rec.endDate + 'T12:00:00') : new Date('2026-06-30T12:00:00');
  const dates = [];
  const current = new Date(start);
  
  // Clamp iteration start to range start
  if(current < rStart) current.setTime(rStart.getTime());
  // But we need to keep start date logic: for weekly, only include days that match
  // So iterate from the event's actual start date
  const iterStart = new Date(start < rStart ? rStart : start);
  current.setTime(iterStart.getTime());
  
  const limit = endDate < rEnd ? endDate : rEnd;
  
  // Safety: max 40 days in festival
  let safety = 0;
  while(current <= limit && safety < 45) {
    const dow = current.getDay(); // 0=Sun..6=Sat
    const dateStr = current.toISOString().split('T')[0];
    
    if(rec.type === 'daily') {
      dates.push(dateStr);
    } else if(rec.type === 'weekly') {
      if(rec.days && rec.days.includes(dow)) {
        dates.push(dateStr);
      }
    }
    current.setDate(current.getDate() + 1);
    safety++;
  }
  return dates;
}

function getEventsOnDate(dateStr) {
  // Returns all events (original objects) that occur on a given date
  // Handles both normal and recurring events
  const result = [];
  events.forEach(ev => {
    if(!ev.date) return;
    if(!ev.recurrence || ev.recurrence.type === 'none') {
      if(ev.date === dateStr) result.push(ev);
    } else {
      const dates = getEventDatesInRange(ev, dateStr, dateStr);
      if(dates.length > 0) result.push(ev);
    }
  });
  return result;
}

function formatRecurrence(event) {
  // Returns a human-readable string for the recurrence, e.g. "Every Saturday until 27 Jun"
  if(!event.recurrence || event.recurrence.type === 'none') return null;
  const rec = event.recurrence;
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let str = '';
  if(rec.type === 'daily') {
    str = 'Every day';
  } else if(rec.type === 'weekly') {
    const dayLabels = (rec.days || []).sort().map(d => dayNames[d]);
    str = 'Every ' + dayLabels.join(', ');
  }
  if(rec.endDate) {
    const endObj = new Date(rec.endDate + 'T12:00:00');
    str += ' until ' + endObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  }
  return str;
}

/* ============================================ */
/* SECTION START: EVENT FORM FUNCTIONS */
/* *** UPDATED VERSION - FIXES TIME DISPLAY IN EDIT MODE *** */
/* ============================================ */
function openEventForm(event=null) {
  document.getElementById('eventModal').classList.add('active');
  document.getElementById('modalTitle').textContent = event ? 'Edit Event' : 'Add New Event';
  
  // Hide jump button to prevent it showing through modal
  const jumpBtn = document.getElementById('jumpToSave');
  if(jumpBtn) jumpBtn.style.display = 'none';
  
  // Immediately reset scroll to top
  const modalContent = document.querySelector('#eventModal .modal-content');
  if(modalContent) modalContent.scrollTop = 0;
  
  // Prevent body scroll when modal is open
  document.body.style.overflow = 'hidden';
  
  // Add touchmove prevention for mobile
  document.body.addEventListener('touchmove', preventScroll, { passive: false });
  document.body.addEventListener('wheel', preventScroll, { passive: false });
  
  if(event){ 
    // SET editingEventId FIRST before anything else so notes can be added immediately
    editingEventId = event.id;
    
    document.getElementById('eventTitle').value = event.title || ''; 
    document.getElementById('eventType').value = event.type || '';
    document.getElementById('eventTopic').value = event.topic || '';
    document.getElementById('eventDescription').value = event.description || '';
    document.getElementById('eventSummary').value = event.summary || '';
    document.getElementById('eventDate').value = event.date || '';
	document.getElementById('eventUniqueId').value = event.uniqueId || '';
	document.getElementById('eventRoughWeek').value = event.roughWeek || '';
    document.getElementById('eventRoughDay').value = event.roughDay || '';
    document.getElementById('eventRoughTime').value = event.roughTime || '';
    
    // Fix for time display in edit form
    if(event.time) {
      const timeParts = event.time.split(':');
      document.getElementById('eventTimeHour').value = timeParts[0] || '';
      document.getElementById('eventTimeMinute').value = timeParts[1] || '00';
    } else {
      document.getElementById('eventTimeHour').value = '';
      document.getElementById('eventTimeMinute').value = '00';
    }
    
    const hours = Math.floor((event.duration || 0) / 60);
    const minutes = (event.duration || 0) % 60;
    document.getElementById('eventDurationHours').value = hours;
    document.getElementById('eventDurationMinutes').value = minutes;
    
    // Load extra time slots
    currentTimeSlots = event.timeSlots ? [...event.timeSlots] : [];
    showTimeSlotsSection();
    renderTimeSlotsList();
    
    // Load recurrence fields
    showRecurrenceSection();
    loadRecurrenceFields(event);
    
    document.getElementById('eventLocation').value = event.location || '';
    document.getElementById('eventPostcode').value = event.postcode || '';
    document.getElementById('eventVenue').value = event.venue || '';
    document.getElementById('eventOrganiser').value = event.organiser || '';
    document.getElementById('eventContactName').value = event.contactName || '';
    document.getElementById('eventContactEmail').value = event.contactEmail || '';
    document.getElementById('eventPaceLead').value = event.paceLead || '';
document.getElementById('eventPaceLeadEmail').value = event.paceLeadEmail || '';
document.getElementById('eventPaceLeadPhone').value = event.paceLeadPhone || '';
document.getElementById('eventAccessCode').value = event.accessCode || '';
renderPlanningNotesList(event.planningNotes);
document.getElementById('eventNewNote').value = '';
    document.getElementById('eventbriteUrl').value = event.eventbriteUrl || '';
    document.getElementById('organisationWebsite').value = event.organisationWebsite || '';
    document.getElementById('organisationAbout').value = event.organisationAbout || '';
    document.getElementById('eventContactPhone').value = event.contactPhone || '';
	// Event ID: Only Admin can edit it, others can't change it
    if(isAdmin) {
      document.getElementById('eventUniqueId').disabled = false;
      document.getElementById('eventUniqueId').style.background = 'white';
      document.getElementById('eventUniqueId').style.cursor = 'text';
    } else {
      document.getElementById('eventUniqueId').disabled = true;
      document.getElementById('eventUniqueId').style.background = '#e0e0e0';
      document.getElementById('eventUniqueId').style.cursor = 'not-allowed';
    }
  } else{ 
    document.getElementById('eventForm').reset(); 
    document.getElementById('eventTimeHour').value = '';
    document.getElementById('eventTimeMinute').value = '00';
    editingEventId = null;
    tempEventNotes = []; // Clear temporary notes
    currentTimeSlots = [];
    document.getElementById('timeSlotsSection').style.display = 'none';
    renderTimeSlotsList();
    // Reset recurrence
    document.getElementById('recurrenceSection').style.display = 'none';
    document.getElementById('recurrenceType').value = 'none';
    document.getElementById('recurrenceDaysRow').style.display = 'none';
    document.getElementById('recurrenceEndRow').style.display = 'none';
    [0,1,2,3,4,5,6].forEach(d => { const cb = document.getElementById('recDay'+d); if(cb) cb.checked = false; });
    document.getElementById('recurrenceEndDate').value = '';
    renderPlanningNotesList([]);
    document.getElementById('eventNewNote').value = '';
	// Enable Event ID when adding new (need to enter it)
    document.getElementById('eventUniqueId').disabled = false;
    document.getElementById('eventUniqueId').style.background = 'white';
    document.getElementById('eventUniqueId').style.cursor = 'text';
    document.getElementById('eventUniqueId').value = '';
  }
  
  // Check if Jump to Save button should be shown when modal first opens
  setTimeout(function() {
    const modalContent = document.querySelector('#eventModal .modal-content');
    const formActions = document.querySelector('.form-actions');
    const jumpBtn = document.getElementById('jumpToSave');
    
    // Reset scroll to top after everything is populated
    if(modalContent) modalContent.scrollTop = 0;
    
    if(modalContent && formActions && jumpBtn) {
      const formActionsRect = formActions.getBoundingClientRect();
      const modalRect = modalContent.getBoundingClientRect();
      
      if(formActionsRect.top > modalRect.bottom) {
        jumpBtn.style.display = 'block';
      }
    }
  }, 100);
}

function closeEventForm() { 
  document.getElementById('eventModal').classList.remove('active');
  
  // Clear temporary notes
  tempEventNotes = [];
  
  // Hide the jump button when modal closes
  const jumpBtn = document.getElementById('jumpToSave');
  if(jumpBtn) jumpBtn.style.display = 'none';
  
  // Reset scroll position to top for next time
  const modalContent = document.querySelector('#eventModal .modal-content');
  if(modalContent) modalContent.scrollTop = 0;
  
  // Clean up PACE view buttons if they exist
  let paceButtons = document.getElementById('paceViewButtons');
  if(paceButtons) paceButtons.remove();
  
  // Re-enable all fields in case they were disabled
  document.querySelectorAll('#eventForm input, #eventForm select, #eventForm textarea').forEach(field => {
    field.disabled = false;
    field.style.background = '';
    field.style.cursor = '';
  });
  
  // Restore Access Code field to normal text input
  const accessCodeField = document.getElementById('eventAccessCode');
  if(accessCodeField) {
    accessCodeField.type = 'text';
  }
  
  // Make sure normal buttons are visible
  const normalButtons = document.querySelector('.form-actions');
  if(normalButtons) normalButtons.style.display = 'flex';
  
  // Re-enable body scroll
  document.body.style.overflow = '';
  document.body.removeEventListener('touchmove', preventScroll);
  document.body.removeEventListener('wheel', preventScroll);
}

// Helper function to prevent scroll on body but allow on modal
function preventScroll(e) {
  const modal = document.getElementById('eventModal');
  const modalContent = modal ? modal.querySelector('.modal-content') : null;
  
  // Allow scroll if the event is inside modal-content
  if(modalContent && modalContent.contains(e.target)) {
    return;
  }
  
  // Otherwise prevent scroll
  e.preventDefault();
}

// Handle Jump to Save button
document.addEventListener('DOMContentLoaded', function() {
  // Always scroll to top when page loads
  window.scrollTo(0, 0);
  
  const jumpBtn = document.getElementById('jumpToSave');
  
  if(jumpBtn) {
    // Click handler to scroll to save buttons
    jumpBtn.addEventListener('click', function() {
      const modalContent = document.querySelector('#eventModal .modal-content');
      if(modalContent) {
        // Scroll the modal content to show the form actions
        modalContent.scrollTop = modalContent.scrollHeight;
      }
    });
  }
  
  // Prevent Enter key from submitting form when typing in input fields
  const eventForm = document.getElementById('eventForm');
  if(eventForm) {
    eventForm.addEventListener('keypress', function(e) {
      // If Enter is pressed and we're in an input or select (not textarea)
      if(e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
        e.preventDefault();
        return false;
      }
    });
  }
  
  // Add scroll listener to modal content to show/hide Jump button
  const modalContent = document.querySelector('#eventModal .modal-content');
  if(modalContent && jumpBtn) {
    modalContent.addEventListener('scroll', function() {
      // Find whichever button set is visible (normal or PACE buttons)
      let formActions = document.getElementById('paceViewButtons');
      if(!formActions || formActions.style.display === 'none') {
        formActions = document.querySelector('.form-actions');
      }
      
      if(!formActions || formActions.style.display === 'none') return;
      
      const formActionsRect = formActions.getBoundingClientRect();
      const modalRect = modalContent.getBoundingClientRect();
      
      // Show button if Save buttons are below visible area (with some buffer)
      if(formActionsRect.top > modalRect.bottom - 50) {
        jumpBtn.style.display = 'block';
      } else {
        jumpBtn.style.display = 'none';
      }
    });
  }
  
  // Handle browser back/forward buttons
  window.addEventListener('popstate', function(e) {
    if(e.state && e.state.page) {
      showPage(e.state.page, null);
    } else {
      // If no state, check hash
      const hash = window.location.hash.substring(1);
      if(hash) {
        showPage(hash, null);
      } else {
        showPage('home', null);
      }
    }
  });
  
  // On page load, check if there's a hash and navigate to it
  const initialHash = window.location.hash.substring(1);
  if(initialHash) {
    showPage(initialHash, null);
  }
});

function saveEvent(e){
  e.preventDefault();
  
  // Check for unsaved note BEFORE saving anything
  const noteField = document.getElementById('eventNewNote');
  if(noteField && noteField.value.trim() !== '') {
    const confirmSave = confirm('You have an unsaved note.\n\nClick OK to save the event without the note, or Cancel to go back and add the note first.');
    if(!confirmSave) {
      // User clicked Cancel - wants to go back and add the note
      const notesSection = noteField.closest('.form-group');
      if(notesSection) {
        notesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      noteField.focus();
      return; // Stop the save
    }
    // User clicked OK - continue with save, clear the unsaved note
    noteField.value = '';
  }
  
  // Get current and new values for validation
  const newAccessCode = document.getElementById('eventAccessCode').value.toUpperCase();
  const newPaceLeadName = document.getElementById('eventPaceLead').value.trim();
  const newPaceLeadEmail = document.getElementById('eventPaceLeadEmail').value.trim();
  
  // If editing an existing event, check if Access Code is being changed
  if(editingEventId !== null && !isAdmin) {
    const idx = events.findIndex(ev => ev.id === editingEventId);
    if(idx !== -1) {
      const oldAccessCode = (events[idx].accessCode || '').toUpperCase();
      const oldPaceLeadName = events[idx].paceLead || '';
      const oldPaceLeadEmail = events[idx].paceLeadEmail || '';
      
      // If Access Code has changed
      if(oldAccessCode !== newAccessCode && oldAccessCode !== '') {
        // Check if name or email also changed
        if(newPaceLeadName === oldPaceLeadName || newPaceLeadEmail === oldPaceLeadEmail) {
          alert('âš ï¸ TRANSFER BLOCKED\n\nYou are changing the Access Code but have not updated the PACE Lead name or email.\n\nBefore transferring an event:\n1. Update PACE Lead Name\n2. Update PACE Lead Email\n3. Then change the Access Code\n\nThis prevents losing track of who is responsible for the event.');
          return; // Stop the save
        }
      }
    }
  }
  const uniqueId = document.getElementById('eventUniqueId').value || ('MANUAL_' + Date.now());
  const title=document.getElementById('eventTitle').value;
  const type=document.getElementById('eventType').value;
  const topic=document.getElementById('eventTopic').value;
  const description=document.getElementById('eventDescription').value;
  const summary=document.getElementById('eventSummary').value;
  const date=document.getElementById('eventDate').value;
  const timeHour=document.getElementById('eventTimeHour').value;
  const timeMinute=document.getElementById('eventTimeMinute').value;
  const time=timeHour + ':' + timeMinute;
  const hours = parseInt(document.getElementById('eventDurationHours').value);
  const mins = parseInt(document.getElementById('eventDurationMinutes').value);
  const duration = (hours * 60) + mins;
  const location=document.getElementById('eventLocation').value;
  const postcode=document.getElementById('eventPostcode').value;
  const venue=document.getElementById('eventVenue').value;
  const organiser=document.getElementById('eventOrganiser').value;
  const contactName=document.getElementById('eventContactName').value;
  const contactEmail=document.getElementById('eventContactEmail').value;
  const contactPhone=document.getElementById('eventContactPhone').value;
  const paceLead=document.getElementById('eventPaceLead').value;
  const paceLeadEmail=document.getElementById('eventPaceLeadEmail').value;
  const paceLeadPhone=document.getElementById('eventPaceLeadPhone').value;
  const accessCode=document.getElementById('eventAccessCode').value;
  const eventbriteUrl=normalizeUrl(document.getElementById('eventbriteUrl').value);
  const organisationWebsite=normalizeUrl(document.getElementById('organisationWebsite').value);
  const organisationAbout=document.getElementById('organisationAbout').value;
  // planningNotes are saved immediately when added via addPlanningNote()
  const roughWeek=document.getElementById('eventRoughWeek').value;
  const roughDay=document.getElementById('eventRoughDay').value;
  const roughTime=document.getElementById('eventRoughTime').value;
  const timeSlots = readTimeSlotsFromForm(); // extra slots beyond the first
  const recurrence = readRecurrenceFromForm(); // null if no repeat


  if(editingEventId!==null){
    const idx = events.findIndex(ev=>ev.id===editingEventId);
    if(idx !== -1) {
      // Store the old uniqueId before changing it
      const oldUniqueId = events[idx].uniqueId || events[idx].id;
      const newUniqueId = uniqueId;
      
      events[idx].uniqueId=uniqueId;
      events[idx].title=title; 
      events[idx].type=type;
      events[idx].topic=topic;
      events[idx].description=description;
      events[idx].summary=summary;
      events[idx].date=date;
      events[idx].time=time;
      events[idx].roughWeek=roughWeek;
      events[idx].roughDay=roughDay;
      events[idx].roughTime=roughTime;
	  events[idx].duration=duration;
      events[idx].location=location;
      events[idx].postcode=postcode;
      events[idx].venue=venue;
      events[idx].organiser=organiser;
      events[idx].contactName=contactName;
      events[idx].contactEmail=contactEmail;
      events[idx].contactPhone=contactPhone;
      events[idx].paceLead=paceLead;
      events[idx].paceLeadEmail=paceLeadEmail;
      events[idx].paceLeadPhone=paceLeadPhone;
      events[idx].accessCode=accessCode;
      events[idx].eventbriteUrl=eventbriteUrl;
      events[idx].organisationWebsite=organisationWebsite;
      events[idx].organisationAbout=organisationAbout;
      events[idx].timeSlots=timeSlots;
      events[idx].recurrence=recurrence;
      // planningNotes are NOT updated here - they're managed separately via addPlanningNote/deleteNote
      
      // If uniqueId changed, delete the old Firebase key
      if(useFirebase && db && oldUniqueId !== newUniqueId) {
        console.log('UniqueId changed from', oldUniqueId, 'to', newUniqueId, '- deleting old Firebase key');
        db.ref('events/' + oldUniqueId).remove()
          .then(() => console.log('Old Firebase key deleted successfully'))
          .catch(err => console.error('Error deleting old Firebase key:', err));
      }
      
      // Log the edit
      addChangeLogEntry('edited', 'Event edited: ' + title, {
        changes: 'Event details updated'
      }, events[idx]);
    }
  }else{
    const newId = Date.now();
    const newEvent = {
  id: newId, 
  uniqueId: uniqueId, 
  title, type, topic, description, summary, date, time, duration, location, postcode, venue, organiser, 
  contactName, contactEmail, contactPhone, paceLead, paceLeadEmail, paceLeadPhone, accessCode, 
  planningNotes: [...tempEventNotes], // Include any notes added during creation
  eventbriteUrl, organisationWebsite, organisationAbout,
  roughWeek, roughDay, roughTime, timeSlots, recurrence
};
    events.push(newEvent);
    
    // Clear temporary notes now that event is created
    tempEventNotes = [];
    
    // Log the new event
    addChangeLogEntry('added', 'New event added: ' + title, {
      changes: 'Event created'
    }, newEvent);
  }
  
  // For edited events, directly update just this one event in Firebase
  if(editingEventId !== null) {
    const idx = events.findIndex(ev=>ev.id===editingEventId);
    if(idx !== -1 && useFirebase && db) {
      const eventToSave = events[idx];
      const key = eventToSave.uniqueId || eventToSave.id;
      console.log('Directly updating Firebase for event:', key, eventToSave.title);
      
      // Update just this one event in Firebase and WAIT for completion
      db.ref('events/' + key).set(eventToSave)
        .then(() => {
          console.log('âœ“ Firebase direct update successful for:', key);
          // Also update localStorage as backup
          localStorage.setItem('mef-events', JSON.stringify(events));
          filteredEvents = [...events];
          document.getElementById('eventCount').textContent = events.length;
          
          // Show success AFTER save completes
          showToast('âœ“ Event saved successfully');
          
          // Now safe to close form and refresh view
          setTimeout(() => {
            closeEventForm();
            refreshCurrentView();
          }, 500);
        })
        .catch(err => {
          console.error('âŒ Firebase save error:', err);
          alert('âš ï¸ SAVE FAILED!\n\nYour changes could not be saved to the cloud.\n\nPlease:\n1. Take a screenshot of your changes\n2. Try saving again\n3. Contact admin if problem persists');
        });
      
      // Exit here - don't continue to the rest of the function
      return;
    } else {
      // No Firebase, just save to localStorage
      saveEvents();
    }
  } else {
    // New event - save everything
    saveEvents();
  }
  
  // Show success toast
  showToast('âœ“ Event saved successfully');
  
  // Close form and refresh
  setTimeout(() => {
    closeEventForm();
    refreshCurrentView();
  }, 500);
}

// Helper function to refresh the current view after save
function refreshCurrentView() {
  console.log('Save refresh - isPaceLead:', isPaceLead, 'currentPaceLeadCode:', currentPaceLeadCode, 'isAdmin:', isAdmin);
  console.log('Events array length:', events.length);
  console.log('adminFilteredEvents before reset:', adminFilteredEvents ? adminFilteredEvents.length : 'null');
  
  // Refresh only the current view - CHECK ADMIN FIRST since admin also has isPaceLead=true
  if(isAdmin) {
    // Reset filtered events to null to force fresh data, then re-apply filters if needed
    const hadFilters = adminFilteredEvents !== null;
    console.log('Admin mode - hadFilters:', hadFilters);
    adminFilteredEvents = null;
    
    if(hadFilters) {
      // Re-apply the filters to get fresh filtered data
      console.log('Re-applying admin filters');
      applyAdminFilters();
    } else {
      // Just render with all events
      console.log('Rendering admin events list');
      renderAdminEventsList();
    }
  } else if(isPaceLead && !currentPaceLeadCode) {
    // In PACE Planning mode (not My Events) - always re-apply filters to get fresh data
    console.log('Calling applyPlanningFilters');
    applyPlanningFilters();
  } else if(currentPaceLeadCode) {
    console.log('Calling renderPaceLeadEvents');
    renderPaceLeadEvents();
  } else {
    // If neither PACE Lead nor Admin, do the full refresh
    console.log('Calling renderEvents and renderCalendar');
    renderEvents();
    renderCalendar();
  }
}

function showToast(message) {
  // Create toast element
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #4CAF50;
    color: white;
    padding: 16px 32px;
    border-radius: 8px;
    font-size: 1em;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease-out;
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 2 seconds
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

/* SECTION END: EVENT FORM FUNCTIONS */

/* ============================================ */
/* SECTION START: IMPORT/EXPORT FUNCTIONS */
/* *** UPDATED VERSION - FIXES CONTACT MAPPING & TIME PARSING *** */
/* ============================================ */
function exportToExcel(){
  if(events.length===0){ alert('No events to export'); return; }
  
  const exportData = events.map(e => {
    // Get most recent planning note text for Progress Note field
    const notes = migrateNotes(e.planningNotes || []);
    const latestNote = notes.length > 0 ? notes[notes.length - 1].text : '';
    
    return {
    'Event ID': e.uniqueId,
    'Code': e.accessCode,
    'Title': e.title,
    'Event Type': e.type,
    'Topic': e.topic,
    'Short description': e.summary,
    'Description': e.description,
    'Progress Note - Give some idea of what stage it is at and what help or resources you need': latestNote,
    'Date if known': e.date,
    'Rough Week': e.roughWeek,
    'Rough Day': e.roughDay,
    'Starting Time': e.time,
    'Rough Time': e.roughTime,
    'Duration Hours': Math.floor((e.duration || 0) / 60),
    'Minutes': (e.duration || 0) % 60,
    'Town': e.location,
    'Post Code of Event': e.postcode,
    'Venue Name': e.venue,
    'FirstName Organiser': e.contactName ? e.contactName.split(' ')[0] : '',
    'Last Name of organiser': e.contactName ? e.contactName.split(' ').slice(1).join(' ') : '',
    'Phone Number of organiser': e.contactPhone,
    "Organiser's Email": e.contactEmail,
    'Organisation Name': e.organiser,
    'Description of the Organisation (if you are one)': e.organisationAbout,
    'Web address of Organiser': e.organisationWebsite,
    'First Name': e.paceLead ? e.paceLead.split(' ')[0] : '',
    'Last Name': e.paceLead ? e.paceLead.split(' ').slice(1).join(' ') : '',
    'Email of Pace Lead': e.paceLeadEmail,
    'Phone Number of PACE Lead': e.paceLeadPhone
  };
});
  
  let ws = XLSX.utils.json_to_sheet(exportData);
  let wb = XLSX.utils.book_new(); 
  XLSX.utils.book_append_sheet(wb, ws, 'Events');
  XLSX.writeFile(wb, 'MEF26_Events.xlsx');
}

// Helper function to format multi-select fields from JotForm
function formatMultiSelect(value) {
  if(!value) return '';
  
  const str = String(value).trim();
  
  // If the string already has commas, return as-is
  if(str.includes(',')) return str;
  
  // Define complete phrases/words that should be recognized as single items
  const patterns = [
    // Days of the week
    { find: /Monday/g, replace: 'Monday, ' },
    { find: /Tuesday/g, replace: 'Tuesday, ' },
    { find: /Wednesday/g, replace: 'Wednesday, ' },
    { find: /Thursday/g, replace: 'Thursday, ' },
    { find: /Friday/g, replace: 'Friday, ' },
    { find: /Saturday/g, replace: 'Saturday, ' },
    { find: /Sunday/g, replace: 'Sunday, ' },
    // Time of day - with exact spelling from JotForm
    { find: /Morning/g, replace: 'Morning, ' },
    { find: /Afternoon/g, replace: 'Afternoon, ' },
    { find: /Aftenoon/g, replace: 'Aftenoon, ' },  // Handle typo if it exists in JotForm
    { find: /Evening/g, replace: 'Evening, ' },
    // Festival weeks with full date ranges
    { find: /Festival Week 1 \(23rd-29th May\)/g, replace: 'Festival Week 1 (23rd-29th May), ' },
    { find: /Festival Week 2 \(30th May-5th June\)/g, replace: 'Festival Week 2 (30th May-5th June), ' },
    { find: /Festival Week 3 \(6th-12th June\)/g, replace: 'Festival Week 3 (6th-12th June), ' },
    { find: /Festival Week 4 \(13th-19th June\)/g, replace: 'Festival Week 4 (13th-19th June), ' },
    { find: /Festival Week 5 \(20th-26th June\)/g, replace: 'Festival Week 5 (20th-26th June), ' },
    { find: /Festival Week 6 \(27th-30th June\)/g, replace: 'Festival Week 6 (27th-30th June), ' },
    // Fallback for shorter festival week format (in case CSV shortens them)
    { find: /Festival Week 1/g, replace: 'Festival Week 1, ' },
    { find: /Festival Week 2/g, replace: 'Festival Week 2, ' },
    { find: /Festival Week 3/g, replace: 'Festival Week 3, ' },
    { find: /Festival Week 4/g, replace: 'Festival Week 4, ' },
    { find: /Festival Week 5/g, replace: 'Festival Week 5, ' },
    { find: /Festival Week 6/g, replace: 'Festival Week 6, ' },
    // Topics - multi-word phrases MUST come before single words
    { find: /Carbon Footprint/g, replace: 'Carbon Footprint, ' },
    // Topics - single words
    { find: /Food/g, replace: 'Food, ' },
    { find: /Biodiversity/g, replace: 'Biodiversity, ' },
    { find: /Environment/g, replace: 'Environment, ' },
    { find: /Nature/g, replace: 'Nature, ' }
  ];
  
  let formatted = str;
  patterns.forEach(pattern => {
    formatted = formatted.replace(pattern.find, pattern.replace);
  });
  
  // Remove trailing comma and space
  formatted = formatted.replace(/, $/, '');
  
  return formatted;
}

// Helper function to normalize URLs
function normalizeUrl(url) {
  if (!url) return url;
  
  // Trim whitespace
  url = url.trim();
  
  // If empty after trimming, return as-is
  if (url === '') return url;
  
  // If it starts with www. but has no protocol, add https://
  if (url.toLowerCase().startsWith('www.')) {
    return 'https://' + url;
  }
  
  // If it has no protocol at all and looks like a domain (contains a dot), add https://
  if (!url.match(/^[a-zA-Z]+:\/\//) && url.includes('.')) {
    return 'https://' + url;
  }
  
  return url;
}

function importFromExcel(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      if(rows.length === 0){
        alert('No rows found in file');
        return;
      }

      let added = 0;
      let updated = 0;

      rows.forEach(r => {
        const uniqueId = String(r['Event ID'] || '');
        console.log('Importing Unique ID:', uniqueId, 'Title:', r['Title']);
        
        if(!uniqueId || uniqueId === 'undefined') {
          console.log('Skipped - no Unique ID');
          return;
        }

        // Find existing event by uniqueId to overwrite
        const existingIndex = events.findIndex(ev => String(ev.uniqueId) === uniqueId);
        
        const hours = parseInt(r['Duration Hours'] || 0);
        const mins  = parseInt(r['Minutes'] || 0);
        
        // Convert Excel date to YYYY-MM-DD format
        let dateStr = '';
        if(r['Date if known']) {
          if(typeof r['Date if known'] === 'number') {
            const excelDate = XLSX.SSF.parse_date_code(r['Date if known']);
            dateStr = `${excelDate.y}-${String(excelDate.m).padStart(2,'0')}-${String(excelDate.d).padStart(2,'0')}`;
          } else {
            // Parse date string like "Jan 14, 2026"
            const parsedDate = new Date(r['Date if known']);
            if(!isNaN(parsedDate)) {
              dateStr = parsedDate.toISOString().split('T')[0];
            }
          }
        }
        
        // Convert Excel time or time string to HH:MM format
        let timeStr = '';
        if(r['Starting Time']) {
          if(typeof r['Starting Time'] === 'number') {
            // Excel time fraction (0.5 = 12:00)
            const timeHours = Math.floor(r['Starting Time'] * 24);
            const timeMins = Math.floor((r['Starting Time'] * 24 * 60) % 60);
            timeStr = `${String(timeHours).padStart(2,'0')}:${String(timeMins).padStart(2,'0')}`;
          } else {
            // Handle string time format like "5:00 PM"
            const timeString = String(r['Starting Time']).trim();
            const timeParsed = parseTimeString(timeString);
            if(timeParsed) {
              timeStr = timeParsed;
            }
          }
        }

        const eventData = {
          id: existingIndex >= 0 ? events[existingIndex].id : Date.now() + Math.floor(Math.random() * 10000),
          uniqueId: uniqueId,
		  accessCode: (r['Code'] || '').toUpperCase(),


          title: r['Title'] || '',
          type: r['Event Type'] || '',
          topic: formatMultiSelect(r['Topic'] || ''),
          summary: r['Short description'] || '',
          description: r['Description'] || '',

          date: dateStr,
          time: timeStr,
          duration: (hours * 60) + mins,
		  // Rough date/time fields - format multi-select values
  roughWeek: formatMultiSelect(r['Rough Week'] || ''),
  roughDay: formatMultiSelect(r['Rough Day'] || ''),
  roughTime: formatMultiSelect(r['Rough Time'] || ''),

          location: r['Town'] || '',
          postcode: r['Post Code of Event'] || '',
          venue: r['Venue Name'] || '',
          organiser: r['Organisation Name'] || '',

          contactName: `${r['FirstName Organiser'] || ''} ${r['Last Name of organiser'] || ''}`.trim(),
contactEmail: r["Organiser's Email"] || '',
contactPhone: r['Phone Number of organiser'] || '',

          organisationAbout: r['Description of the Organisation (if you are one)'] || '',
          organisationWebsite: normalizeUrl(r['Web address of Organiser'] || ''),

          paceLead: `${r['First Name'] || ''} ${r['Last Name'] || ''}`.trim(),
          paceLeadEmail: r['Email of Pace Lead'] || '',
          paceLeadPhone: r['Phone Number of PACE Lead'] || '',
          
          // Handle Progress Note - if present, add as a planning note
          planningNotes: [] // Will be populated below if needed
        };
        
        // If Progress Note field has content, create a planning note
        const progressNote = r['Progress Note - Give some idea of what stage it is at and what help or resources you need'];
        if(progressNote && String(progressNote).trim() !== '') {
          eventData.planningNotes = [{
            text: String(progressNote).trim(),
            date: new Date().toISOString()
          }];
        }

        if(existingIndex >= 0) {
  // Smart update - only replace non-blank fields
  const oldEvent = events[existingIndex];
  const updatedEvent = { ...oldEvent }; // Start with old data
  
  // Special handling for planningNotes - append if new note exists
  const newProgressNote = eventData.planningNotes && eventData.planningNotes.length > 0 ? eventData.planningNotes[0] : null;
  
  // Update each field only if new value is not blank
  Object.keys(eventData).forEach(key => {
    if(key === 'id' || key === 'uniqueId') {
      // Always keep original id and uniqueId
      return;
    }
    if(key === 'planningNotes') {
      // Special handling - append new note if it exists and is different from last note
      if(newProgressNote) {
        const existingNotes = migrateNotes(oldEvent.planningNotes || []);
        const lastNoteText = existingNotes.length > 0 ? existingNotes[existingNotes.length - 1].text : '';
        // Only append if the new note is different from the last note
        if(newProgressNote.text !== lastNoteText) {
          updatedEvent.planningNotes = [...existingNotes, newProgressNote];
        }
      }
      return; // Don't do the normal update for planningNotes
    }
    const newValue = eventData[key];
    if(newValue !== '' && newValue !== null && newValue !== undefined) {
      updatedEvent[key] = newValue;
    }
    // If newValue is blank, keep old value (do nothing)
  });
  
  events[existingIndex] = updatedEvent;
           updated++;
          console.log('Updated event:', uniqueId);
        } else {
          // Add new event
          events.push(eventData);
          added++;
          console.log('Added event:', uniqueId);
        }
      });

      saveEvents();

      alert(
        `Import complete:\n\n` +
        `âœ” Added: ${added}\n` +
        `ğŸ”„ Updated: ${updated}`
      );

      document.getElementById('importFile').value = '';

    } catch(err){
      alert('Import failed: ' + err.message);
      console.error('Import error:', err);
    }
  };

  reader.readAsArrayBuffer(file);
}
/* SECTION END: IMPORT/EXPORT FUNCTIONS */

/* ============================================ */
/* SECTION START: MODAL FUNCTIONS */
/* ============================================ */
function closePrideModal() {
  document.getElementById('prideModal').classList.remove('active');
}

function showPrideModal() {
  document.getElementById('prideModal').classList.add('active');
}

function closeEventDetailModal() {
  document.getElementById('eventDetailModal').classList.remove('active');
  
  // Show scroll-to-top button again if scrolled down
  const scrollBtn = document.getElementById('scrollToTop');
  if(scrollBtn && window.pageYOffset > 150) {
    scrollBtn.style.display = 'block';
  }
}

function showEventDetailModal(eventId) {
  const event = events.find(e => Number(e.id) === Number(eventId));
  if(!event) return;
  
  document.getElementById('eventDetailTitle').textContent = event.title;
  document.getElementById('eventDetailSubtitle').textContent = event.type || 'Event';
  
  let gridHTML = '';
  if(event.date) {
    const dateObj = new Date(event.date + 'T12:00:00');
    const dateStr = dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    gridHTML += `<div class="event-detail-item"><div class="event-detail-label">ğŸ“… Date</div><div class="event-detail-value">${dateStr}</div></div>`;
  }
  const detRecStr = formatRecurrence(event);
  if(detRecStr) {
    gridHTML += `<div class="event-detail-item"><div class="event-detail-label">ğŸ” Repeats</div><div class="event-detail-value">${detRecStr}</div></div>`;
  }
  if(event.time) {
    const allSlots = getAllTimeSlots(event);
    if(allSlots.length > 1) {
      gridHTML += `<div class="event-detail-item" style="grid-column: 1 / -1;"><div class="event-detail-label">â° Sessions</div><div class="event-detail-value">`;
      allSlots.forEach(slot => {
        gridHTML += `<div style="padding: 3px 0;">${formatSlotTime(slot)}</div>`;
      });
      gridHTML += `</div></div>`;
    } else {
      gridHTML += `<div class="event-detail-item"><div class="event-detail-label">ğŸ• Time</div><div class="event-detail-value">${event.time}</div></div>`;
    }
  }
  if(event.duration && !(event.timeSlots && event.timeSlots.length > 0)) {
    gridHTML += `<div class="event-detail-item"><div class="event-detail-label">â±ï¸ Duration</div><div class="event-detail-value">${formatDuration(event.duration)}</div></div>`;
  }
  if(event.location) {
    gridHTML += `<div class="event-detail-item"><div class="event-detail-label">ğŸ“ Location</div><div class="event-detail-value">${event.location}</div></div>`;
  }
  if(event.venue) {
    gridHTML += `<div class="event-detail-item"><div class="event-detail-label">ğŸ›ï¸ Venue</div><div class="event-detail-value">${event.venue}</div></div>`;
  }
  document.getElementById('eventDetailGrid').innerHTML = gridHTML;
  
  document.getElementById('eventDetailDescription').innerHTML = event.description || '<em>No description available</em>';
  
  let extraHTML = '';
  
  // Organisation section
  // Organisation section
if(event.organiser || event.organisationAbout || event.organisationWebsite) {
  extraHTML += '<div class="organisation-section">';
  <!--extraHTML += '<h3 style="color: #2B7BBD;">This Event is run by</h3>';-->
  if(event.organiser) {
    extraHTML += `<p style="font-size: 1.1em; margin-bottom: 15px;">This event is run by <strong style="color: #2B7BBD;">${event.organiser}</strong></p>`;
  }
  if(event.organisationAbout) {
    extraHTML += `<p>${event.organisationAbout}</p>`;
  }
       if(event.organisationWebsite) {
      extraHTML += `<p><a href="${event.organisationWebsite}" target="_blank" class="event-link" style="display: inline-block; margin-top: 10px;">ğŸŒ Visit Organisation Website</a></p>`;
    }
    extraHTML += '</div>';
  }
  
  document.getElementById('eventDetailExtra').innerHTML = extraHTML;
  
  let actionsHTML = '';
  if(event.eventbriteUrl) {
    actionsHTML += `<a href="${event.eventbriteUrl}" target="_blank" class="event-modal-btn event-modal-btn-primary">ğŸ“… Book Your Place on Eventbrite</a>`;
  }
  actionsHTML += `<button onclick="closeEventDetailModal()" class="event-modal-btn event-modal-btn-secondary">Close</button>`;
  document.getElementById('eventDetailActions').innerHTML = actionsHTML;
  
  const modal = document.getElementById('eventDetailModal');
  modal.classList.add('active');
  
  // Hide scroll-to-top button when modal is open
  const scrollBtn = document.getElementById('scrollToTop');
  if(scrollBtn) {
    scrollBtn.style.setProperty('display', 'none', 'important');
  }
  
  // Scroll modal container to top to ensure header is visible
  setTimeout(function() {
    modal.scrollTop = 0;
  }, 50);
}

// Click outside modal to close
document.addEventListener('click', function(e) {
  const prideModal = document.getElementById('prideModal');
  const eventModal = document.getElementById('eventDetailModal');
  if(e.target === prideModal) {
    closePrideModal();
  }
  if(e.target === eventModal) {
    closeEventDetailModal();
  }
});
/* SECTION END: MODAL FUNCTIONS */

/* ============================================ */
/* SECTION START: VENUES MANAGEMENT */
/* ============================================ */

function showPlanningView(view) {
  const eventsView = document.getElementById('planningEventsView');
  const venuesView = document.getElementById('planningVenuesView');
  const eventsBtn = document.getElementById('btnPlanningEvents');
  const venuesBtn = document.getElementById('btnPlanningVenues');
  
  if(view === 'events') {
    eventsView.style.display = 'block';
    venuesView.style.display = 'none';
    eventsBtn.classList.remove('btn-secondary');
    eventsBtn.style.background = '#2B7BBD';
    venuesBtn.classList.add('btn-secondary');
    venuesBtn.style.background = '';
  } else if(view === 'venues') {
    eventsView.style.display = 'none';
    venuesView.style.display = 'block';
    venuesBtn.classList.remove('btn-secondary');
    venuesBtn.style.background = '#2B7BBD';
    eventsBtn.classList.add('btn-secondary');
    eventsBtn.style.background = '';
    renderVenuesList();
  }
}

function loadVenues() {
  if(useFirebase && db) {
    db.ref('venues').once('value', function(snapshot) {
      if(snapshot.exists()) {
        const data = snapshot.val();
        venues = Object.values(data);
      } else {
        venues = [];
      }
      document.getElementById('venueCount').textContent = venues.length;
    });
  } else {
    const stored = localStorage.getItem('mef-venues');
    if(stored) venues = JSON.parse(stored);
    document.getElementById('venueCount').textContent = venues.length;
  }
}

function saveVenues() {
  if(useFirebase && db) {
    const venuesObj = {};
    venues.forEach((v) => { venuesObj[v.id] = v; });
    db.ref('venues').set(venuesObj).catch(err => console.error('Firebase save error:', err));
  } else {
    localStorage.setItem('mef-venues', JSON.stringify(venues));
  }
  document.getElementById('venueCount').textContent = venues.length;
}

function openVenueForm(venue = null) {
  document.getElementById('venueModal').classList.add('active');
  document.getElementById('venueModalTitle').textContent = venue ? 'Edit Venue' : 'Add New Venue';
  document.body.style.overflow = 'hidden';
  
  if(venue) {
    document.getElementById('venueName').value = venue.name || '';
    document.getElementById('venueAddress').value = venue.address || '';
    document.getElementById('venuePostcode').value = venue.postcode || '';
    document.getElementById('venueCapacity').value = venue.capacity || '';
    document.getElementById('venueFacilities').value = venue.facilities || '';
    document.getElementById('venueAvailability').value = venue.availability || '';
    document.getElementById('venueContact').value = venue.contact || '';
    document.getElementById('venueContactEmail').value = venue.contactEmail || '';
    document.getElementById('venueContactPhone').value = venue.contactPhone || '';
    document.getElementById('venueNotes').value = venue.notes || '';
    editingVenueId = venue.id;
  } else {
    document.getElementById('venueForm').reset();
    editingVenueId = null;
  }
}

function closeVenueForm() {
  document.getElementById('venueModal').classList.remove('active');
  document.body.style.overflow = '';
}

function saveVenue(e) {
  e.preventDefault();
  
  const venueData = {
    name: document.getElementById('venueName').value,
    address: document.getElementById('venueAddress').value,
    postcode: document.getElementById('venuePostcode').value,
    capacity: parseInt(document.getElementById('venueCapacity').value) || 0,
    facilities: document.getElementById('venueFacilities').value,
    availability: document.getElementById('venueAvailability').value,
    contact: document.getElementById('venueContact').value,
    contactEmail: document.getElementById('venueContactEmail').value,
    contactPhone: document.getElementById('venueContactPhone').value,
    notes: document.getElementById('venueNotes').value
  };
  
  if(editingVenueId !== null) {
    // Edit existing
    const idx = venues.findIndex(v => v.id === editingVenueId);
    if(idx !== -1) {
      venues[idx] = { ...venues[idx], ...venueData };
      addChangeLogEntry('venue', 'Venue updated: ' + venueData.name, {
        venueName: venueData.name,
        changes: 'Venue details updated'
      }, null);
    }
  } else {
    // Add new
    venueData.id = Date.now();
    venues.push(venueData);
    addChangeLogEntry('venue', 'New venue added: ' + venueData.name, {
      venueName: venueData.name,
      changes: 'Venue created'
    }, null);
  }
  
  saveVenues();
  closeVenueForm();
  renderVenuesList();
}

function deleteVenue(id) {
  const venueToDelete = venues.find(v => v.id === id);
  if(!confirm('Are you sure you want to delete this venue?')) return;
  
  // Log before deleting
  if(venueToDelete) {
    addChangeLogEntry('venue', 'Venue deleted: ' + venueToDelete.name, {
      venueName: venueToDelete.name,
      changes: 'Venue permanently removed'
    }, null);
  }
  
  venues = venues.filter(v => v.id !== id);
  saveVenues();
  renderVenuesList();
}

function renderVenuesList() {
  const container = document.getElementById('venuesList');
  container.innerHTML = '';
  
  if(venues.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No venues yet. Click Add New Venue to create one.</p>';
    return;
  }
  
  // Sort alphabetically
  const sorted = [...venues].sort((a, b) => a.name.localeCompare(b.name));
  
  sorted.forEach(v => {
    const eventsAtVenue = events.filter(e => e.venue && e.venue.toLowerCase() === v.name.toLowerCase());
    
    let div = document.createElement('div');
    div.className = 'admin-event-item';
    div.style.borderLeftColor = '#8DC63F';
    
    let html = '<div class="admin-event-info">';
    html += '<h3 class="admin-event-title" style="color: #8DC63F;">ğŸ›ï¸ ' + v.name + '</h3>';
    
    if(v.address) html += '<p class="admin-event-meta">ğŸ“ ' + v.address + '</p>';
    if(v.postcode) html += '<p class="admin-event-meta">Postcode: ' + v.postcode + '</p>';
    if(v.capacity) html += '<p class="admin-event-meta">ğŸ‘¥ Capacity: ' + v.capacity + ' people</p>';
    
    if(v.facilities) {
      html += '<div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">';
      html += '<strong>Facilities:</strong><br>' + v.facilities.replace(/\n/g, '<br>');
      html += '</div>';
    }
    
    if(v.availability) {
      html += '<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">';
      html += '<strong>âš ï¸ Availability Notes:</strong><br>' + v.availability.replace(/\n/g, '<br>');
      html += '</div>';
    }
    
    if(v.contact || v.contactEmail || v.contactPhone) {
      html += '<div style="margin-top: 10px;">';
      html += '<strong>Contact:</strong><br>';
      if(v.contact) html += v.contact + '<br>';
      if(v.contactEmail) html += 'ğŸ“§ ' + v.contactEmail + '<br>';
      if(v.contactPhone) html += 'ğŸ“ ' + v.contactPhone;
      html += '</div>';
    }
    
    if(v.notes) {
      html += '<div style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px;">';
      html += '<strong>Notes:</strong><br>' + v.notes.replace(/\n/g, '<br>');
      html += '</div>';
    }
    
    // Show events scheduled at this venue
    if(eventsAtVenue.length > 0) {
      html += '<div style="margin-top: 15px; padding: 10px; background: #f0f7ff; border-left: 4px solid #2B7BBD; border-radius: 5px;">';
      html += '<strong style="color: #2B7BBD;">ğŸ“… ' + eventsAtVenue.length + ' event(s) scheduled here:</strong><br>';
      eventsAtVenue.forEach(e => {
        html += '<div style="margin-top: 5px;">';
        html += 'â€¢ ' + e.title;
        if(e.date) html += ' (' + formatDate(e.date) + ')';
        html += '</div>';
      });
      html += '</div>';
    }
    
    html += '</div>';
    html += '<div class="admin-event-actions">';
    html += '<button class="btn" style="margin-right: 10px;" onclick="openVenueForm(venues.find(v => v.id === ' + v.id + '))">Edit</button>';
    html += '<button class="btn btn-secondary" onclick="deleteVenue(' + v.id + ')">Delete</button>';
    html += '</div>';
    
    div.innerHTML = html;
    container.appendChild(div);
  });
}

/* SECTION END: VENUES MANAGEMENT */

/* ============================================ */
/* SECTION START: CHANGE LOG SYSTEM */
/* ============================================ */

function loadChangeLog() {
  if(useFirebase && db) {
    db.ref('changeLog').once('value', function(snapshot) {
      if(snapshot.exists()) {
        const data = snapshot.val();
        changeLog = Object.values(data);
      } else {
        changeLog = [];
      }
      filteredChangeLog = [...changeLog];
    });
  } else {
    const stored = localStorage.getItem('mef-changelog');
    if(stored) {
      changeLog = JSON.parse(stored);
    } else {
      changeLog = [];
    }
    filteredChangeLog = [...changeLog];
  }
}

function saveChangeLog() {
  if(useFirebase && db) {
    const logObj = {};
    changeLog.forEach((entry, idx) => {
      logObj[entry.id || idx] = entry;
    });
    db.ref('changeLog').update(logObj).catch(err => console.error('Change log save error:', err));
  } else {
    localStorage.setItem('mef-changelog', JSON.stringify(changeLog));
  }
}

function addChangeLogEntry(type, action, details, eventData) {
  const entry = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    type: type, // 'added', 'edited', 'deleted', 'note', 'venue'
    action: action, // Human-readable action description
    details: details, // Object with relevant details
    eventTitle: eventData ? eventData.title : '',
    eventId: eventData ? (eventData.uniqueId || eventData.id) : '',
    paceLead: eventData ? eventData.paceLead : '',
    accessCode: eventData ? eventData.accessCode : ''
  };
  
  changeLog.unshift(entry); // Add to beginning
  
  // Keep only last 500 entries to prevent database bloat
  if(changeLog.length > 500) {
    changeLog = changeLog.slice(0, 500);
  }
  
  saveChangeLog();
}

function openChangeLog() {
  loadChangeLog();
  document.getElementById('changeLogModal').classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // Wait a moment for data to load, then render
  setTimeout(() => {
    renderChangeLog();
  }, 500);
}

function closeChangeLog() {
  document.getElementById('changeLogModal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

function renderChangeLog() {
  const container = document.getElementById('changeLogList');
  
  if(filteredChangeLog.length === 0) {
    container.innerHTML = '<p style="padding: 40px; text-align: center; color: #999;">No changes recorded yet.</p>';
    return;
  }
  
  // Sort by timestamp, newest first
  const sorted = [...filteredChangeLog].sort((a, b) => {
    return new Date(b.timestamp) - new Date(a.timestamp);
  });
  
  let html = '';
  sorted.forEach(entry => {
    const date = new Date(entry.timestamp);
    const dateStr = date.toLocaleDateString('en-GB', { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    // Color coding by type
    let borderColor = '#999';
    let icon = 'ğŸ“';
    if(entry.type === 'added') { borderColor = '#28a745'; icon = 'âœ…'; }
    if(entry.type === 'edited') { borderColor = '#2B7BBD'; icon = 'âœï¸'; }
    if(entry.type === 'deleted') { borderColor = '#dc3545'; icon = 'ğŸ—‘ï¸'; }
    if(entry.type === 'note') { borderColor = '#ffc107'; icon = 'ğŸ“'; }
    if(entry.type === 'venue') { borderColor = '#8DC63F'; icon = 'ğŸ›ï¸'; }
    
    html += '<div style="padding: 15px; border-left: 4px solid ' + borderColor + '; border-bottom: 1px solid #eee;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">';
    html += '<div style="flex: 1;">';
    html += '<div style="font-weight: bold; color: #2B7BBD; margin-bottom: 5px;">';
    html += icon + ' ' + entry.action + '</div>';
    
    if(entry.eventTitle) {
      html += '<div style="color: #666; margin-bottom: 5px;">Event: <strong>' + entry.eventTitle + '</strong></div>';
    }
    
    if(entry.paceLead) {
      html += '<div style="color: #666; font-size: 0.9em;">PACE Lead: ' + entry.paceLead + '</div>';
    }
    
    // Show details if available
    if(entry.details && typeof entry.details === 'object') {
      html += '<div style="margin-top: 8px; padding: 8px; background: #f9f9f9; border-radius: 5px; font-size: 0.9em;">';
      
      if(entry.details.noteText) {
        html += '<strong>Note:</strong> ' + entry.details.noteText.substring(0, 100);
        if(entry.details.noteText.length > 100) html += '...';
      }
      
      if(entry.details.changes) {
        html += '<strong>Changes:</strong> ' + entry.details.changes;
      }
      
      if(entry.details.venueName) {
        html += '<strong>Venue:</strong> ' + entry.details.venueName;
      }
      
      html += '</div>';
    }
    
    html += '</div>';
    html += '<div style="font-size: 0.85em; color: #999; white-space: nowrap;">' + dateStr + '</div>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function filterChangeLog() {
  const search = document.getElementById('changeLogSearch').value.toLowerCase();
  const typeFilter = document.getElementById('changeLogTypeFilter').value;
  
  filteredChangeLog = changeLog.filter(entry => {
    const matchesSearch = !search || 
      entry.action.toLowerCase().includes(search) ||
      (entry.eventTitle && entry.eventTitle.toLowerCase().includes(search)) ||
      (entry.paceLead && entry.paceLead.toLowerCase().includes(search));
    
    const matchesType = typeFilter === 'all' || entry.type === typeFilter;
    
    return matchesSearch && matchesType;
  });
  
  renderChangeLog();
}

function clearChangeLog() {
  if(!confirm('Are you sure you want to clear the entire change log? This cannot be undone.')) return;
  
  changeLog = [];
  filteredChangeLog = [];
  saveChangeLog();
  renderChangeLog();
}

/* SECTION END: CHANGE LOG SYSTEM */
/* ============================================ */
/* END OF JAVASCRIPT - CLOSE SCRIPT TAG */
/* ============================================ */
</script>

    <!-- Scroll to Top Button -->
    <button id="scrollToTop" style="position: fixed; bottom: 20px; right: 20px; 
      background: #2B7BBD; color: white; border: none; padding: 10px 16px; 
      border-radius: 25px; z-index: 1000; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-size: 14px; cursor: pointer; font-weight: bold;">
      â†‘ Menu
    </button>

    <script>
    // Show/hide scroll button based on scroll position
    window.addEventListener('scroll', function() {
      const btn = document.getElementById('scrollToTop');
      if (window.pageYOffset > 150) {
        btn.style.display = 'block';
      } else {
        btn.style.display = 'none';
      }
    });

    // Scroll to top when clicked
    document.getElementById('scrollToTop').addEventListener('click', function() {
      window.scrollTo({top: 0, behavior: 'smooth'});
    });
    </script>

  </body>
</html>

